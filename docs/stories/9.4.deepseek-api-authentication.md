# Story 9.4: DeepSeek API Authentication

## Status

Done

## Story

**As a** system administrator deploying the application,
**I want** to verify and enhance DeepSeek API Bearer token authentication,
**so that** the system reliably authenticates with DeepSeek API and provides proper error handling for authentication failures.

## Acceptance Criteria

1. DeepSeek client integrated with Settings configuration system (use `Settings.deepseek_api_key` instead of direct `os.getenv`)
2. Bearer token authentication verified and working correctly with DeepSeek API
3. Proper error handling for authentication failures (invalid key, missing key, expired key scenarios)
4. Enhanced error messages that distinguish between authentication errors and other API errors
5. Configuration validation at application startup (warn if key missing but allow app to start)
6. Health check integration: `/readyz` endpoint includes DeepSeek authentication configuration check (verify API key is configured, NOT make actual API calls to avoid billing)
7. Comprehensive unit tests for authentication scenarios
8. Integration test verifying actual DeepSeek API authentication (with mock or test key)
9. Documentation updated with authentication configuration requirements

## Tasks / Subtasks

- [x] Integrate DeepSeek client with Settings configuration (AC: 1)
  - [x] Update `deepseek_chat()` function to accept optional `api_key` parameter or get from Settings
  - [x] Modify DeepSeek client to use `Settings.deepseek_api_key` as primary source, fallback to env var
  - [x] Ensure backward compatibility with existing `DEEPSEEK_API_KEY` environment variable
- [x] Verify Bearer token authentication (AC: 2)
  - [x] Review OpenAI client Bearer token implementation (handled automatically by OpenAI client)
  - [x] Verify token format and header transmission to DeepSeek API
  - [x] Test with valid API key to confirm authentication works
- [x] Implement enhanced error handling (AC: 3, 4)
  - [x] Catch and categorize authentication-specific exceptions
  - [x] Create custom exception types for authentication errors (InvalidAPIKeyError, MissingAPIKeyError)
  - [x] Improve error messages to clearly indicate authentication vs. other failures
  - [x] Update error responses to follow standardized error model
- [x] Add configuration validation (AC: 5)
  - [x] Add startup validation check in main.py or config initialization
  - [x] Log warning if DeepSeek API key is missing (non-blocking for MVP)
  - [x] Provide clear guidance in error messages about configuration requirements
- [x] Integrate with health check (AC: 6)
  - [x] Add DeepSeek configuration check to `/readyz` endpoint (verify API key is configured)
  - [x] **IMPORTANT**: Do NOT make actual DeepSeek API calls for health check (would incur billing costs)
  - [x] Check only that `Settings.deepseek_api_key` or `DEEPSEEK_API_KEY` is present and non-empty
  - [x] Return appropriate status in readiness check response (configured/unconfigured)
- [x] Unit testing (AC: 7)
  - [x] Create/update test file `tests/unit/test_deepseek_client.py`
  - [x] Test missing API key scenario
  - [x] Test invalid API key scenario
  - [x] Test valid authentication flow
  - [x] Test error handling and exception types
- [x] Integration testing (AC: 8)
  - [x] Create integration test for DeepSeek API authentication
  - [x] Test with mock responses for various authentication scenarios
  - [x] Verify Bearer token header is correctly formatted and sent
- [x] Documentation updates (AC: 9)
  - [x] Update env.example with DeepSeek API key configuration
  - [x] Add authentication troubleshooting section to relevant docs
  - [x] Document error codes and messages for authentication failures

## Dev Notes

### Previous Story Insights

From Story 9.1 (DeepSeek Client Integration):

- DeepSeek client successfully implemented with OpenAI-compatible interface
- Currently uses `os.getenv("DEEPSEEK_API_KEY")` directly
- Function `deepseek_chat(messages, temperature=0.1, max_tokens=700)` available at `app/deps/deepseek_client.py`
- OpenAI client automatically handles Bearer token authentication via `api_key` parameter
- Error handling currently raises generic exceptions with minimal context

From Story 9.2 (Chat Orchestrator Service):

- Chat orchestrator successfully integrates with DeepSeek client
- Service located at `app/services/chat_orchestrator.py`
- Orchestrator calls `deepseek_chat()` for answer synthesis
- Error handling in orchestrator may need updates to handle new authentication error types

From Story 9.3 (Chat API Endpoint):

- Chat API endpoint at `app/api/routes/chat.py`
- Endpoint calls chat orchestrator which uses DeepSeek client
- Current error handling follows standardized error model
- May need to enhance error responses for authentication-specific failures

### Data Models

**Settings Configuration:**

```python
class Settings(BaseSettings):
    # DeepSeek Configuration
    deepseek_api_key: Optional[str] = None  # Currently defined but not used
```

[Source: app/core/config.py lines 46-47]

**Error Response Schema:**

```python
{
    "error": {
        "code": str,        # Error code (e.g., "AUTH_ERROR", "INVALID_API_KEY")
        "message": str,     # Human-readable error message
        "details": dict,    # Additional error details
        "requestId": str    # Request ID for tracking
    }
}
```

[Source: architecture/7-error-model-json.md]

### API Specifications

**DeepSeek API Authentication:**

- **Method**: Bearer token authentication (handled by OpenAI client)
- **Header**: `Authorization: Bearer {api_key}`
- **Configuration**: Via `DEEPSEEK_API_KEY` environment variable (currently) or `Settings.deepseek_api_key` (to be implemented)
- **Base URL**: `https://api.deepseek.com/v1`
- **Authentication Errors**: OpenAI client raises `AuthenticationError` or similar exceptions for auth failures

[Source: app/deps/deepseek_client.py lines 31-40]

**Health Check Endpoint:**

- **Endpoint**: `GET /readyz`
- **Purpose**: Verify dependencies and return component statuses
- **Response Format**:

```json
{
  "status": "ready",
  "components": {
    "qdrant": "ok",
    "postgres": "ok",
    "embeddings": "ok",
    "llm": "ok" // Should include DeepSeek configuration check (not API call - to avoid billing)
  },
  "checked_at": "2025-09-29T00:00:00Z"
}
```

[Source: architecture/6-health-readiness-checks.md]

### Component Specifications

**DeepSeek Client Enhancement:**

- Update function signature to support Settings-based configuration
- Maintain backward compatibility with environment variable
- Implement custom exception types for better error categorization
- Enhance error messages to distinguish authentication errors from other API errors

**Health Check Implementation (Cost-Aware):**

- Health check should verify API key configuration only (presence/non-empty check)
- **CRITICAL**: Do NOT make actual DeepSeek API calls during health checks to avoid billing costs
- Health checks run frequently and API calls would consume tokens and incur charges
- Pattern: Check `settings.deepseek_api_key` or `os.getenv("DEEPSEEK_API_KEY")` is configured, not validate with actual API call

**Current Implementation Pattern:**

```python
api_key = os.getenv("DEEPSEEK_API_KEY")
if not api_key:
    raise ValueError("DEEPSEEK_API_KEY environment variable is required")

client = OpenAI(
    api_key=api_key,
    base_url="https://api.deepseek.com/v1"
)
```

**Proposed Enhancement:**

```python
# Support both Settings and env var, with Settings taking precedence
api_key = settings.deepseek_api_key or os.getenv("DEEPSEEK_API_KEY")
if not api_key:
    raise MissingAPIKeyError("DeepSeek API key is required")

# OpenAI client handles Bearer token automatically
```

[Source: app/deps/deepseek_client.py lines 31-40]

**Error Handling Patterns:**

- Catch `openai.AuthenticationError` for invalid/missing keys
- Catch `openai.APIError` for other API errors
- Return standardized error responses following error model
- Log authentication failures with appropriate detail level

[Source: architecture/7-error-model-json.md]

### File Locations

Based on project structure analysis:

- **DeepSeek client**: `app/deps/deepseek_client.py` (modify existing)
- **Settings configuration**: `app/core/config.py` (modify existing - use existing field)
- **Main application**: `app/main.py` (modify to add startup validation)
- **Health check endpoint**: `app/api/routes/health.py` or existing health route (modify to include DeepSeek check)
- **Test file**: `tests/unit/test_deepseek_client.py` (modify existing)
- **Integration test**: `tests/integration/test_deepseek_auth.py` (new file)

### Technical Constraints

- **Python version**: Compatible with existing Python 3.11+ requirement
- **OpenAI client version**: Use existing OpenAI library (handles Bearer token automatically)
- **Configuration system**: Must integrate with existing Pydantic Settings pattern
- **Backward compatibility**: Must support existing `DEEPSEEK_API_KEY` environment variable
- **Error handling**: Must follow standardized error model from architecture
- **Health checks**: Must align with existing `/readyz` endpoint pattern

[Source: architecture/3-highlevel-design-snapshot.md#3.4]

### Testing Requirements

**Unit Testing:**

- **Test file location**: `tests/unit/test_deepseek_client.py`
- **Testing framework**: pytest (following existing project patterns)
- **Mock requirements**: Mock OpenAI client responses for authentication scenarios
- **Coverage**: Test all authentication error scenarios, valid authentication, configuration integration

**Integration Testing:**

- **Test file location**: `tests/integration/test_deepseek_auth.py`
- **Testing framework**: pytest with FastAPI TestClient
- **Mock strategy**: Use mock responses for DeepSeek API or test with invalid key format
- **Coverage**: Verify Bearer token header format, authentication flow, error responses

**Test Scenarios:**

- Missing API key (empty/missing env var and Settings)
- Invalid API key format
- Invalid/expired API key (401 authentication error)
- Valid API key authentication success
- Configuration priority (Settings over env var)
- Error message clarity and error code correctness

[Source: architecture/7-error-model-json.md]

### Project Structure Notes

The DeepSeek client is located in `app/deps/deepseek_client.py` following the dependency injection pattern. The Settings class in `app/core/config.py` already has the `deepseek_api_key` field defined but it's not currently used. This story will integrate the client with the Settings system while maintaining backward compatibility with direct environment variable access.

**Critical Billing Consideration:**

- DeepSeek API charges based on API calls (token consumption)
- Health checks run frequently (often every few seconds by orchestration tools)
- Making actual DeepSeek API calls during health checks would incur significant costs
- Solution: Health check should verify configuration presence only, not make actual API calls
- This follows the existing pattern in `app/services/health_service.py` which uses lightweight checks (e.g., `SELECT 1` for database, collection ping for Qdrant)

## Testing

### Testing Standards

- **Test file location**: `tests/unit/test_deepseek_client.py` (update existing), `tests/integration/test_deepseek_auth.py` (new)
- **Testing framework**: pytest (following existing project patterns)
- **Mock strategy**: Use `unittest.mock` or `pytest-mock` to mock OpenAI client responses
- **Test coverage**: Unit tests for all authentication scenarios and configuration integration, integration tests for end-to-end authentication verification

### Specific Testing Requirements

- Mock OpenAI client authentication errors (`openai.AuthenticationError`)
- Test Settings integration vs. environment variable priority
- Test error handling and custom exception types
- Test health check integration with DeepSeek configuration check (verify no API calls are made during health checks)
- Verify Bearer token header format and transmission
- Test backward compatibility with existing environment variable usage
- Integration test with mock API responses for various authentication scenarios

## Change Log

| Date       | Version | Description                    | Author                 |
| ---------- | ------- | ------------------------------ | ---------------------- |
| 2025-11-02 | 1.0     | Initial story creation         | Scrum Master           |
| 2025-11-02 | 1.1     | Story implementation completed | James (Dev Agent)      |
| 2025-11-02 | 1.2     | QA review completed, gate PASS | Quinn (Test Architect) |
| 2025-11-02 | 2.0     | Story marked as Done           | Story Owner            |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

N/A - No debug log entries required for this implementation

### Completion Notes List

1. **Settings Integration**: Successfully integrated DeepSeek client with Settings configuration system, maintaining backward compatibility with environment variables. Settings.deepseek_api_key takes precedence over DEEPSEEK_API_KEY env var.

2. **Custom Exceptions**: Created MissingAPIKeyError and InvalidAPIKeyError custom exception types for better error categorization. Exceptions properly propagate through chat orchestrator to chat API endpoint.

3. **API Key Sanitization**: Implemented sanitize_api_key utility function to prevent API key exposure in logs and error messages (SEC-001 mitigation). All error handling paths sanitize API keys before logging or returning to clients.

4. **Error Handling**: Enhanced error handling distinguishes authentication errors from other API errors. Chat endpoint returns appropriate error codes (AUTH_ERROR, INVALID_API_KEY) following standardized error model.

5. **Startup Validation**: Added non-blocking startup validation that logs warning if API key is missing. Application starts successfully even without key to support MVP flexibility.

6. **Health Check Integration**: Integrated DeepSeek configuration check into /readyz endpoint. **Critical**: Health check only verifies configuration presence, does NOT make actual API calls to avoid billing costs (OPS-001 mitigation).

7. **Testing**: Comprehensive unit tests (17 tests) and integration tests (15 tests) covering all acceptance criteria. Tests verify configuration precedence, error handling, sanitization, and health check behavior.

8. **Documentation**: Updated env.example with DeepSeek configuration details and added troubleshooting section to README.md documenting error codes and resolution steps.

### File List

**Modified Files:**

- `app/deps/deepseek_client.py` - Enhanced with Settings integration, custom exceptions, and sanitization
- `app/services/chat_orchestrator.py` - Updated to handle new authentication exception types
- `app/api/routes/chat.py` - Added error handling for authentication errors with proper error codes
- `app/main.py` - Added startup validation for DeepSeek API key
- `app/services/health_service.py` - Integrated DeepSeek configuration check in readiness endpoint
- `tests/unit/test_deepseek_client.py` - Comprehensive unit tests (17 tests, all passing)
- `tests/integration/test_deepseek_auth.py` - Integration tests for authentication scenarios (15 tests)
- `env.example` - Added DeepSeek API key configuration documentation
- `README.md` - Added troubleshooting section for DeepSeek authentication

**New Files:**

- `app/deps/exceptions.py` - Custom exception types (MissingAPIKeyError, InvalidAPIKeyError)
- `app/deps/utils.py` - API key sanitization utility function

## QA Results

### Risk Profile Assessment

**Date**: 2025-11-02  
**Assessed by**: Quinn (Test Architect)

**Risk Profile**: `docs/qa/assessments/9.4-risk-20251102.md`

**Summary**:

- Total Risks: 12
- Critical: 1 (SEC-001: API key exposure)
- High: 2 (OPS-001: Health check billing, SEC-002: Plaintext storage)
- Medium: 5 (Technical and operational concerns)
- Low: 4 (Minor risks)

**Overall Risk Score**: 76/100 (Moderate risk)

**Critical Findings**:

1. **SEC-001 (Critical)**: API key exposure risk in logs/error messages - MUST implement key sanitization before deployment
2. **OPS-001 (High)**: Health check must NOT make API calls - requires explicit testing to verify
3. **SEC-002 (High)**: API keys in plaintext - document secrets management for production

**Recommendations**:

- Implement API key sanitization utility
- Add explicit test preventing API calls in health checks
- Document production secrets management practices
- Implement custom exception types for better error categorization

### Test Design

**Date**: 2025-11-02  
**Designed by**: Quinn (Test Architect)

**Test Design Matrix**: `docs/qa/assessments/9.4-test-design-20251102.md`

**Summary**:

- Total Test Scenarios: 24 automated + 3 manual
- Unit Tests: 13 (54%)
- Integration Tests: 9 (38%)
- E2E Tests: 2 (8%)
- Priority Distribution: P0: 9, P1: 10, P2: 5

**Coverage Highlights**:

- ✅ All 9 acceptance criteria have test coverage
- ✅ Critical security risk (SEC-001) covered by 9.4-UNIT-006 and 9.4-INT-006
- ✅ High billing risk (OPS-001) covered by 9.4-INT-013 and 9.4-UNIT-011
- ✅ Backward compatibility (TECH-001) covered by configuration precedence tests
- ✅ Error handling (TECH-002) comprehensively tested at unit and integration levels

**Key Test Scenarios**:

- **P0 Security Tests**: API key sanitization, health check no API calls, authentication flow
- **P0 Error Handling**: Missing/invalid key exceptions, error categorization
- **P1 Configuration**: Settings integration, backward compatibility, startup validation
- **P1 User Experience**: Error message clarity, chat endpoint authentication

**Execution Order**: P0 unit tests → P0 integration tests → P0 E2E tests → P1 tests → P2 tests

### Review

**Date**: 2025-11-02  
**Reviewed By**: Quinn (Test Architect)

**Code Quality Assessment**: Excellent

The implementation demonstrates strong attention to security, operational concerns, and code quality. All critical and high-risk items from the risk profile have been successfully mitigated. The code follows best practices for error handling, API key protection, and test coverage.

**Key Strengths**:

1. **Security Excellence**: API key sanitization utility (`app/deps/utils.py`) comprehensively prevents key exposure in logs and error messages. All error handling paths properly sanitize API keys before logging or returning to clients.

2. **Critical Risk Mitigation**: Both SEC-001 (API key exposure) and OPS-001 (health check billing) have been fully addressed:

   - `sanitize_api_key()` function masks keys in all error paths
   - Health check explicitly avoids API calls (configuration check only)
   - Tests verify no API keys appear in error responses

3. **Clean Architecture**: Well-structured exception hierarchy (`app/deps/exceptions.py`) with proper error propagation through the call stack (client → orchestrator → API endpoint).

4. **Comprehensive Testing**: 17 unit tests and 15 integration tests covering all acceptance criteria. Test coverage includes security-critical scenarios, configuration precedence, error handling, and operational safeguards.

5. **Operational Excellence**: Non-blocking startup validation allows application flexibility while providing clear guidance. Health check integration follows cost-aware patterns.

**Refactoring Performed**: None required - code quality is already excellent

**Compliance Check**:

- ✅ Coding Standards: Fully compliant - follows Python best practices, proper error handling, clear docstrings
- ✅ Project Structure: Properly organized - exceptions and utilities in `app/deps/`, services follow existing patterns
- ✅ Testing Strategy: Excellent coverage - unit tests for logic, integration tests for component interaction, E2E tests for user flows
- ✅ All ACs Met: All 9 acceptance criteria fully implemented and tested

**Improvements Checklist**:

- [x] API key sanitization implemented (SEC-001 mitigation)
- [x] Health check avoids API calls (OPS-001 mitigation)
- [x] Custom exception types created for better error categorization
- [x] Comprehensive unit and integration tests implemented
- [x] Documentation updated (env.example, README troubleshooting section)
- [x] Error handling follows standardized error model
- [x] Startup validation implemented (non-blocking)

**Security Review**: PASS

- API keys are properly sanitized in all error handling paths
- No hardcoded secrets in code
- Error messages don't expose sensitive information
- Health check implementation prevents accidental billing

**Performance Considerations**: PASS

- Health check uses lightweight configuration check (no API calls)
- Error handling is efficient with proper exception propagation
- No performance concerns identified

**Files Modified During Review**: None - implementation is complete and high quality

**Requirements Traceability**:

| AC  | Implementation                             | Test Coverage                                                      | Status      |
| --- | ------------------------------------------ | ------------------------------------------------------------------ | ----------- |
| 1   | Settings integration with env var fallback | 9.4-UNIT-001, 9.4-UNIT-002, 9.4-UNIT-003, 9.4-INT-001, 9.4-INT-002 | ✅ Complete |
| 2   | Bearer token authentication verified       | 9.4-INT-003, 9.4-INT-004, 9.4-INT-005                              | ✅ Complete |
| 3   | Error handling for auth failures           | 9.4-UNIT-004, 9.4-UNIT-005, 9.4-INT-007, 9.4-INT-008               | ✅ Complete |
| 4   | Enhanced error messages                    | 9.4-UNIT-008, 9.4-UNIT-009, 9.4-INT-009                            | ✅ Complete |
| 5   | Startup validation                         | 9.4-INT-010, 9.4-INT-011                                           | ✅ Complete |
| 6   | Health check integration (no API calls)    | 9.4-UNIT-011, 9.4-INT-012, 9.4-INT-013, 9.4-INT-014                | ✅ Complete |
| 7   | Unit tests                                 | 17 tests, all passing                                              | ✅ Complete |
| 8   | Integration tests                          | 15 tests, all passing                                              | ✅ Complete |
| 9   | Documentation                              | env.example, README.md updated                                     | ✅ Complete |

**Gate Status**: PASS → `docs/qa/gates/9.4-deepseek-api-authentication.yml`

**Quality Score**: 95/100

- Deductions: -5 for minor documentation enhancement opportunities (production secrets management best practices could be expanded)

**Recommended Status**: ✓ Ready for Done

**Additional Notes**:

1. Implementation successfully addresses all critical and high risks identified in the risk profile
2. Code demonstrates excellent security awareness with comprehensive API key protection
3. Test coverage is thorough and aligns with the test design document
4. Health check implementation correctly avoids API calls to prevent billing costs
5. All acceptance criteria are fully met with appropriate test coverage

**Risk Mitigation Verification**:

- **SEC-001 (Critical)**: ✅ Fully mitigated - `sanitize_api_key()` implemented and used throughout all error paths
- **OPS-001 (High)**: ✅ Fully mitigated - Health check only checks configuration presence, explicitly avoids API calls
- **SEC-002 (High)**: ✅ Documented in env.example - production secrets management noted

The story is production-ready and demonstrates excellent engineering practices.

# Story 9.2: Chat Orchestrator Service

## Status

Done

## Story

**As a** developer implementing the chat functionality,
**I want** to create a chat orchestrator service that handles retrieval, reranking, context building, and answer synthesis,
**so that** the chat API can provide synthesized answers from retrieved document chunks with proper citations.

## Acceptance Criteria

1. Chat orchestrator service (`app/services/chat_orchestrator.py`) with retrieval, reranking, and synthesis
2. Function `retrieve_candidates(query: str, top_k: int = 20)` → list of candidate chunks
3. Function `rerank(query: str, candidates: list, top_k: int = 8)` → reranked chunks
4. Context building with bracketed indices and metadata
5. System prompt: "You are a document QA assistant. You must answer strictly using the provided CONTEXT."
6. User message wrapper with explicit grounding instructions
7. Integration with existing hybrid search service (no changes required)
8. Integration with existing reranker service (no changes required)
9. Integration with DeepSeek client from story 9.1
10. No persistence required (save_turn() and load_history() as no-ops)

## Tasks / Subtasks

- [x] Create chat orchestrator service (`app/services/chat_orchestrator.py`) (AC: 1)
  - [x] Import existing hybrid search service
  - [x] Import existing reranker service
  - [x] Import DeepSeek client from story 9.1
  - [x] Create ChatOrchestrator class with proper initialization
- [x] Implement retrieval function (AC: 2)
  - [x] Create `retrieve_candidates()` method with hybrid search integration
  - [x] Handle query processing and candidate retrieval
  - [x] Return list of candidate chunks with metadata
- [x] Implement reranking function (AC: 3)
  - [x] Create `rerank()` method with reranker service integration
  - [x] Process candidates through reranker
  - [x] Return top-k reranked chunks
- [x] Implement context building (AC: 4)
  - [x] Create context building method with bracketed indices
  - [x] Include metadata (doc_id, chunk_id, page info, etc.)
  - [x] Format context for LLM consumption
- [x] Implement answer synthesis (AC: 5, 6)
  - [x] Create system prompt with grounding instructions
  - [x] Create user message wrapper with context
  - [x] Integrate with DeepSeek client for answer generation
  - [x] Handle response processing and validation
- [x] Implement no-op persistence methods (AC: 10)
  - [x] Create `save_turn()` method (no-op)
  - [x] Create `load_history()` method (no-op)
- [x] Unit testing (AC: 1-10)
  - [x] Create test file `tests/unit/test_chat_orchestrator.py`
  - [x] Test retrieval functionality with mock hybrid search
  - [x] Test reranking functionality with mock reranker
  - [x] Test context building with sample chunks
  - [x] Test answer synthesis with mock DeepSeek client
  - [x] Test error handling and edge cases
  - [x] Test integration between all components

## Dev Notes

### Previous Story Insights

From Story 9.1 (DeepSeek Client Integration):

- DeepSeek client successfully implemented with OpenAI-compatible interface
- Function `deepseek_chat(messages, temperature=0.1, max_tokens=700)` available
- Environment variable `DEEPSEEK_API_KEY` configured
- Client located at `app/deps/deepseek_client.py`
- Comprehensive error handling and testing implemented

### Data Models

**Chunk Data Structure:**

```python
{
    "doc_id": str,
    "chunk_id": str,
    "method": int,
    "page_from": int,
    "page_to": int,
    "hash": str,
    "text": str,
    "score": float  # from hybrid search or reranker
}
```

**Context Format for LLM:**

```
[1] Document: {doc_title} (Page {page_from}-{page_to})
{chunk_text}

[2] Document: {doc_title} (Page {page_from}-{page_to})
{chunk_text}
```

[Source: architecture/9-data-model.md#9.1]

### API Specifications

**Existing Services Integration:**

- **Hybrid Search Service**: Returns ranked chunks with scores from vector + lexical search
- **Reranker Service**: Cross-encoder reranking for improved relevance
- **DeepSeek Client**: OpenAI-compatible chat completion interface

**Chat Orchestrator Interface:**

```python
class ChatOrchestrator:
    def retrieve_candidates(self, query: str, top_k: int = 20) -> List[Dict]
    def rerank(self, query: str, candidates: List[Dict], top_k: int = 8) -> List[Dict]
    def synthesize_answer(self, query: str, context_chunks: List[Dict]) -> str
    def save_turn(self) -> None  # no-op
    def load_history(self) -> None  # no-op
```

[Source: architecture/3-highlevel-design-snapshot.md#3.1]

### Component Specifications

**System Prompt Template:**

```
You are a document QA assistant. You must answer strictly using the provided CONTEXT.
Do not use any external knowledge. If the answer cannot be found in the provided context,
respond with "I couldn't find relevant information in the provided documents."
```

**User Message Template:**

```
Question: {user_query}

Context:
{formatted_context_with_bracketed_indices}

Please provide a comprehensive answer based only on the context above. Include citations using the bracketed numbers [1], [2], etc.
```

[Source: architecture/14-llm-integration-architecture.md#14.2]

### File Locations

Based on project structure analysis:

- **Orchestrator service**: `app/services/chat_orchestrator.py` (new file)
- **Test file**: `tests/unit/test_chat_orchestrator.py` (new file)
- **Existing services**: `app/services/hybrid_search.py`, `app/services/reranker.py` (import existing)
- **DeepSeek client**: `app/deps/deepseek_client.py` (import from story 9.1)

### Technical Constraints

- **Python version**: Compatible with existing Python 3.11+ requirement
- **Dependencies**: Use existing services without modification
- **Error handling**: Must handle service failures gracefully with proper fallbacks
- **Performance**: Efficient context building and chunk processing
- **Integration**: Seamless integration with existing hybrid search and reranker services

[Source: architecture/3-highlevel-design-snapshot.md#3.4]

### Testing Requirements

- **Test location**: `tests/unit/test_chat_orchestrator.py`
- **Testing framework**: Follow existing pytest patterns in the project
- **Mock requirements**: Mock all external service dependencies (hybrid search, reranker, DeepSeek client)
- **Coverage**: Test all public methods, error handling, context building, and integration flows
- **Integration testing**: Test end-to-end orchestrator flow with mocked services

[Source: architecture/7-error-model-json.md]

### Project Structure Notes

The chat orchestrator will be placed in the existing `app/services/` directory alongside other service modules. This follows the established pattern of organizing business logic services in this location.

## Testing

### Testing Standards

- **Test file location**: `tests/unit/test_chat_orchestrator.py`
- **Testing framework**: pytest (following existing project patterns)
- **Mock strategy**: Use `unittest.mock` or `pytest-mock` to mock all external dependencies
- **Test coverage**: Unit tests for all public methods and error scenarios
- **Integration testing**: Test orchestrator flow with mocked services

### Specific Testing Requirements

- Mock hybrid search service responses to avoid external dependencies
- Mock reranker service responses for testing reranking functionality
- Mock DeepSeek client responses for testing answer synthesis
- Test context building with various chunk formats and metadata
- Test error handling for service failures and invalid responses
- Test parameter validation (top_k limits, query validation)
- Verify proper integration between all orchestrator components

## Change Log

| Date       | Version | Description              | Author       |
| ---------- | ------- | ------------------------ | ------------ |
| 2025-10-28 | 1.0     | Initial story creation   | Scrum Master |
| 2025-10-28 | 1.1     | Implementation completed | Dev Agent    |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

Claude Sonnet 4 (via Cursor AI)

### Debug Log References

No debug logs required - implementation completed successfully without issues.

### Completion Notes List

- Successfully created ChatOrchestrator class with proper service integration
- Implemented all required methods: retrieve_candidates, rerank, synthesize_answer, save_turn, load_history
- Added comprehensive error handling with proper exception propagation
- Implemented context building with bracketed indices and metadata formatting
- Created system prompt and user message templates as specified
- Integrated seamlessly with existing hybrid search, reranker, and DeepSeek services
- Created comprehensive unit test suite with 19 test cases covering all functionality
- All tests passing with 100% success rate
- No linting errors detected
- Implementation follows existing project patterns and coding standards

### File List

**Created:**

- `app/services/chat_orchestrator.py` - Main chat orchestrator service implementation
- `tests/unit/test_chat_orchestrator.py` - Comprehensive unit test suite

**Modified:**

- No existing files modified - clean integration with existing services

## QA Results

### Review Date: 2025-10-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** - The implementation demonstrates high-quality software engineering practices with comprehensive error handling, proper abstraction, and thorough testing. The code follows clean architecture principles and maintains excellent separation of concerns.

**Strengths:**

- Clean, well-documented class with comprehensive docstrings
- Robust error handling with proper exception chaining and logging
- Excellent test coverage with 19 comprehensive test cases
- Proper mocking strategy avoiding external API dependencies
- Seamless integration with existing services without modification
- Follows established project patterns and coding standards
- Type hints and proper imports throughout
- Efficient context building with intelligent metadata handling

### Refactoring Performed

**No refactoring required** - The implementation is already well-structured and follows best practices. The code quality is excellent for an MVP implementation.

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to Python best practices
- **Project Structure**: ✓ Proper directory structure and file organization
- **Testing Strategy**: ✓ Comprehensive unit testing with proper mocking
- **All ACs Met**: ✓ All 10 acceptance criteria fully implemented and validated

### Improvements Checklist

- [x] Comprehensive error handling implemented
- [x] Proper service integration without modification
- [x] Complete test coverage with 19 test cases
- [x] Context building with bracketed indices and metadata
- [x] System prompt and user message templates implemented
- [x] No-op persistence methods as specified
- [x] Clean separation of concerns and proper abstraction
- [ ] Consider adding integration tests for end-to-end validation (future enhancement)
- [ ] Consider adding performance benchmarks for large document sets (future enhancement)

### Security Review

**Status: PASS** - Security implementation is solid for MVP:

- Proper input validation and sanitization in context building
- No direct user input exposure to external APIs
- Proper error handling without information leakage
- System prompt includes grounding instructions to prevent hallucination
- No hardcoded secrets or credentials

### Performance Considerations

**Status: PASS** - Performance characteristics are appropriate:

- Efficient context building with minimal string operations
- Proper handling of empty results and edge cases
- Clean service integration without unnecessary overhead
- Logging at appropriate levels for debugging without performance impact
- Mock-based testing ensures fast test execution

### Files Modified During Review

**No files modified during review** - Implementation was already complete and high-quality.

### Gate Status

Gate: PASS → docs/qa/gates/9.2-chat-orchestrator-service.yml
Risk profile: docs/qa/assessments/9.2-risk-20251028.md
Test design: docs/qa/assessments/9.2-test-design-20251028.md

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met, comprehensive testing implemented, and code quality is excellent. This implementation is ready for integration into the next phase of the DeepSeek chat integration epic.

# Story 9.5: React Chat UI

## Status

Done

## Story

**As a** user interacting with the document search system,
**I want** a conversational chat interface alongside the search page,
**so that** I can ask questions in natural language and receive synthesized answers with citations from the document corpus.

## Acceptance Criteria

1. Create new chat page (`src/pages/ChatPage.tsx`) with chat interface
2. Chat interface displays conversation history with user messages and assistant responses
3. Input box and send functionality for submitting chat messages
4. Citations side panel displaying source information (doc_id, chunk_id, score, text, page info)
5. Stable conversation_id (UUID generated on component mount, persists for session)
6. Integration with POST /api/chat endpoint using existing API service pattern
7. Error handling for API failures with user-friendly error messages
8. Loading states during API requests
9. Responsive design matching existing UI patterns (Tailwind CSS)
10. Existing search page (`src/pages/SearchPage.tsx`) remains unchanged and fully functional (search endpoint and UI remain available)

## Tasks / Subtasks

- [x] Create chat API service function (AC: 6)
  - [x] Add `sendChatMessage` function to `src/services/api.ts`
  - [x] Define TypeScript interfaces for ChatRequest, ChatResponse, and ChatError
  - [x] Handle API errors with proper error model (extract error.message from ChatError response)
  - [x] Use React Query's `useMutation` hook (not `useQuery`) for POST requests
- [x] Create ChatInterface component (AC: 2, 3, 8)
  - [x] Create `src/components/ChatInterface.tsx`
  - [x] Implement message state management with conversation history
  - [x] Implement input box with send button (textarea or input, maxLength 1000)
  - [x] Add keyboard shortcut (Enter to submit, Shift+Enter for new line if textarea)
  - [x] Add empty state (welcome message when no messages)
  - [x] Add loading states during API requests (disable input/button while loading)
  - [x] Implement error handling and display (show error.message from API response)
  - [x] Auto-scroll message area to bottom on new messages
  - [x] Disable send button when input empty or loading
- [x] Create new ChatPage (AC: 1)
  - [x] Create `src/pages/ChatPage.tsx` as new page component
  - [x] Use ChatInterface component in ChatPage
  - [x] Set page title and description to reflect chat functionality
  - [x] Generate stable conversation_id on component mount (UUID)
  - [x] Add route in `src/App.tsx` for `/chat` path
  - [x] Wrap ChatPage with ProtectedRoute and Layout (consistent with SearchPage pattern)
- [x] Implement citations display (AC: 4)
  - [x] Create citations side panel component or section (responsive: side on desktop, below on mobile)
  - [x] Display citation information: doc_id, chunk_id, score, text, page_from, page_to
  - [x] Sort citations by score (highest first)
  - [x] Format scores as percentages
  - [x] Show truncated text with expand option if needed (max 200 chars)
  - [x] Handle empty citations array (show "No citations available" message)
- [x] Styling and responsive design (AC: 9)
  - [x] Apply Tailwind CSS classes matching existing component patterns
  - [x] Ensure mobile-responsive layout
  - [x] Match existing color scheme and typography
  - [x] Style message bubbles (user vs assistant)
- [x] Testing (AC: 1-10)
  - [x] Unit tests for ChatInterface component state management (15 tests in `src/tests/ChatInterface.test.tsx`)
  - [x] Integration tests for API service integration (11 tests in `src/tests/integration/ChatIntegration.test.tsx`)
  - [x] Test conversation_id persistence
  - [x] Test error handling and loading states
  - [x] Test citations display

## Dev Notes

### Previous Story Insights

From Story 9.3 (Chat API Endpoint):

- Chat API endpoint successfully implemented at POST /api/chat
- Request schema: `{ "conversation_id": string, "message": string }`
- Response schema: `{ "answer": string, "citations": array, "conversation_id": string, "latency_ms": int }`
- Error responses follow standardized error model with `{ "error": { "code", "message", "details", "requestId" } }`
- Endpoint integrated with chat orchestrator service and handles authentication errors properly
- API located at `app/api/routes/chat.py`

From Story 9.4 (DeepSeek API Authentication):

- DeepSeek API authentication working correctly with Bearer token
- Error handling distinguishes authentication errors (AUTH_ERROR, INVALID_API_KEY) from other errors
- API key sanitization prevents key exposure in logs

### Data Models

**Chat Request Schema:**

```typescript
interface ChatRequest {
  conversation_id: string; // UUID string for conversation tracking
  message: string; // User message (1-1000 characters)
}
```

**Chat Response Schema:**

```typescript
interface Citation {
  doc_id: string;
  chunk_id: string;
  page_from?: number;
  page_to?: number;
  score: number; // 0.0 to 1.0
  text: string;
}

interface ChatResponse {
  answer: string;
  citations: Citation[];
  conversation_id: string; // Echoed conversation ID
  latency_ms: number;
}
```

**Chat Error Schema:**

```typescript
interface ChatError {
  error: {
    code: string; // Error code (e.g., "CHAT_ERROR", "AUTH_ERROR", "INVALID_API_KEY")
    message: string; // Human-readable error message
    details: Record<string, any>;
    requestId: string;
  };
}
```

[Source: app/schemas/chat.py]

### API Specifications

**Chat Endpoint:**

- **Method**: POST
- **Path**: `/api/chat`
- **Request**: `{ "conversation_id": string (UUID), "message": string (1-1000 chars) }`
- **Response**: `{ "answer": string, "citations": Citation[], "conversation_id": string, "latency_ms": number }`
- **Authentication**: No user authentication required (MVP scope - public endpoint)
- **Error Responses**: Follow standardized error model at HTTP status 500 or 400

[Source: app/api/routes/chat.py, docs/stories/9.3.chat-api-endpoint.md]

**Existing API Service Pattern:**

- API service located at `src/services/api.ts`
- Uses axios with base URL configuration
- Request/response interceptors for auth and error handling
- Functions export from `apiService` object (e.g., `apiService.searchDocuments()`)
- Uses React Query (`@tanstack/react-query`) for data fetching and caching

[Source: src/services/api.ts]

### Component Specifications

**Current SearchPage Component:**

- Located at `src/pages/SearchPage.tsx`
- Simple wrapper component that renders SearchInterface
- Uses Layout component wrapper
- Protected route (requires authentication)
- **Note**: SearchPage will remain unchanged. ChatPage will follow similar pattern.

**Current SearchInterface Component:**

- Located at `src/components/SearchInterface.tsx`
- Uses React Query for search API calls
- Debounced input with 500ms delay
- Displays search results in list format
- Uses Tailwind CSS for styling
- Includes error handling and loading states

**UI Patterns to Follow:**

- Tailwind CSS utility classes
- Card components with `card` class
- Form inputs with `form-input` class
- Icons from `lucide-react` library
- Loading states with conditional rendering
- Error messages with AlertCircle icon
- Responsive design with mobile-first approach

[Source: src/components/SearchInterface.tsx, src/components/Layout.tsx]

**Message Display Pattern:**

- User messages: Right-aligned, different background color
- Assistant messages: Left-aligned, different background color
- Message bubbles with padding and rounded corners
- Timestamp optional (not required for MVP)

**Citations Display:**

- Side panel (desktop) or below chat area (mobile responsive)
- Collapsible/expandable panel is optional for MVP
- List of citation objects, sorted by score (highest first)
- Format score as percentage: `(score * 100).toFixed(1)%`
- Truncate text with ellipsis if needed (e.g., max 200 characters with "..." or expand option)
- Display doc_id, chunk_id, page info if available
- Show "No citations available" message when citations array is empty
- Clickable citations (optional - link to document view in future)
- Responsive: On mobile (< 768px), citations can appear below chat messages instead of side-by-side

### File Locations

Based on project structure analysis:

- **Chat Page**: `src/pages/ChatPage.tsx` (new)
- **App Routing**: `src/App.tsx` (modify existing - add /chat route)
- **Chat Interface Component**: `src/components/ChatInterface.tsx` (new)
- **API Service**: `src/services/api.ts` (modify existing - add chat function)
- **Type Definitions**: Add to `src/services/api.ts` or create `src/types/chat.ts` (optional)
- **Test Files**: `tests/frontend/components/ChatInterface.test.tsx` (if frontend tests exist) or unit tests in component file

[Source: src/pages/SearchPage.tsx, src/components/SearchInterface.tsx, src/services/api.ts]

### Technical Constraints

- **React Version**: Compatible with existing React 18+ setup
- **TypeScript**: Must use TypeScript with proper type definitions
- **State Management**: React hooks (useState, useEffect) for component state
- **API Calls**: Use React Query (`@tanstack/react-query`) for data fetching (consistent with existing pattern)
- **Styling**: Tailwind CSS utility classes (no CSS modules or styled-components)
- **Routing**: React Router for navigation (existing setup)
- **Icons**: Lucide React icon library (consistent with existing components)
- **No Streaming**: Simple request/response (no WebSocket or Server-Sent Events)

[Source: src/components/SearchInterface.tsx, src/services/api.ts]

### Integration Requirements

- **Conversation ID**: Generate UUID on component mount using `crypto.randomUUID()` or `uuid` library. Persists for component lifecycle (lost on page refresh/navigation - not persisted to localStorage)
- **Message History**: Store in component state (array of `{ role: "user" | "assistant", content: string }`)
- **API Integration**: Use React Query's `useMutation` for POST requests (not `useQuery`). Call POST /api/chat with conversation_id and message
- **Error Handling**: Display user-friendly error messages from API error responses. Show `error.message` from ChatError response. Use AlertCircle icon pattern consistent with SearchInterface
- **Loading States**: Show loading indicator during API requests. Disable input and send button while loading
- **Citation Updates**: Update citations panel when new response arrives. Handle empty citations array gracefully (show "No citations available" or hide panel)
- **Empty State**: Display welcome message or placeholder when conversation history is empty (e.g., "Ask a question to get started")
- **Input Validation**: Message input accepts 1-1000 characters. Consider adding character counter (optional for MVP) or maxLength attribute
- **Keyboard Shortcuts**: Enter key should submit message (Shift+Enter for new line if using textarea, or standard Enter for input)
- **Auto-scroll**: Chat message area should automatically scroll to bottom when new messages arrive
- **Send Button State**: Disable send button when input is empty or when loading

### Testing Requirements

**Test File Location**: `tests/frontend/` (if exists) or component-level unit tests

**Testing Framework**:

- React Testing Library for component testing
- Jest for unit tests
- Mock API calls using React Query's testing utilities

**Test Coverage**:

- Component renders correctly
- Message input and submission works
- API calls are made with correct parameters
- Error handling displays properly
- Loading states show/hide correctly
- Conversation ID persists across renders
- Citations display correctly with all fields
- Responsive design works on mobile/desktop

[Source: Existing test patterns from backend tests - apply similar structure to frontend]

### Project Structure Notes

The frontend follows a component-based architecture:

- Pages in `src/pages/`
- Reusable components in `src/components/`
- Services in `src/services/`
- Types can be defined inline or in separate type files

The existing SearchPage uses ProtectedRoute wrapper and remains unchanged. ChatPage will follow the same pattern for consistency, using ProtectedRoute and Layout wrapper. Both pages will be accessible via separate routes (/search and /chat).

## Change Log

| Date       | Version | Description                                                                         | Author                 |
| ---------- | ------- | ----------------------------------------------------------------------------------- | ---------------------- |
| 2025-11-02 | 1.0     | Initial story creation                                                              | Bob (Scrum Master)     |
| 2025-11-04 | 1.1     | Changed from converting SearchPage to creating new ChatPage                         | Quinn (Test Architect) |
| 2025-11-04 | 1.2     | Story implementation completed - all tasks done, tests passing                      | Auto (AI Assistant)    |
| 2025-11-04 | 1.3     | Integration tests added (11 tests) - all tests passing                              | Auto (AI Assistant)    |
| 2025-11-04 | 1.4     | Story marked as Done - all acceptance criteria met, gate PASS, ready for production | Auto (AI Assistant)    |

## QA Results

### Review Date: 2025-11-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: Excellent implementation quality. The code follows React best practices, uses TypeScript effectively, and demonstrates solid understanding of React Query patterns. The component architecture is clean with proper separation of concerns. Error handling is comprehensive, and the responsive design is well-implemented.

**Strengths:**

- Clean component structure with proper TypeScript typing
- Correct use of React Query's `useMutation` for POST requests
- Comprehensive error handling with user-friendly messages
- Proper state management with React hooks
- Responsive design implemented correctly (citations panel adapts to mobile/desktop)
- Good test coverage with 15 unit tests covering all major functionality
- Proper guard for `scrollIntoView` to handle jsdom test environment

**Code Patterns Observed:**

- Follows existing project patterns (matching SearchInterface structure)
- Consistent use of Tailwind CSS classes
- Proper integration with ProtectedRoute and Layout wrappers
- UUID generation with fallback for browser compatibility

### Refactoring Performed

**File**: `src/components/ChatInterface.tsx` (line 24-30)

- **Change**: Added guard check for `scrollIntoView` function availability
- **Why**: jsdom test environment doesn't implement `scrollIntoView`, causing test failures
- **How**: Added conditional check `typeof messagesEndRef.current.scrollIntoView === "function"` before calling the method, ensuring tests pass while maintaining functionality in real browsers

### Compliance Check

- **Coding Standards**: ✓ Code follows React/TypeScript best practices, consistent with existing codebase patterns
- **Project Structure**: ✓ Files are organized correctly (`src/pages/`, `src/components/`, `src/services/`)
- **Testing Strategy**: ✓ Comprehensive unit tests (15 tests) covering all acceptance criteria, using React Testing Library and Vitest
- **All ACs Met**: ✓ All 10 acceptance criteria are fully implemented and tested

### Requirements Traceability

**AC Coverage Analysis:**

- **AC1** (ChatPage creation): ✓ Covered by tests - component renders, route integration verified
- **AC2** (Conversation history): ✓ Covered - tests verify message rendering for both user and assistant
- **AC3** (Input and send): ✓ Covered - tests verify input, submit, Enter key, button states
- **AC4** (Citations display): ✓ Covered - tests verify citation rendering, sorting, formatting, empty state
- **AC5** (Conversation ID): ✓ Covered - UUID generation and persistence tested
- **AC6** (API integration): ✓ Covered - tests verify `sendChatMessage` calls with correct parameters
- **AC7** (Error handling): ✓ Covered - tests verify error display from API responses
- **AC8** (Loading states): ✓ Covered - tests verify loading indicators and disabled states
- **AC9** (Responsive design): ✓ Verified - responsive citations panel implemented (side on desktop, below on mobile)
- **AC10** (SearchPage unchanged): ✓ Verified - SearchPage remains untouched, new ChatPage created separately

**Test Coverage Summary:**

- **Unit Tests**: 15 tests in `src/tests/ChatInterface.test.tsx` covering all major functionality
- **Integration Tests**: 11 tests in `src/tests/integration/ChatIntegration.test.tsx` covering:
  - Routing integration (INT-001, INT-002, INT-023, INT-024)
  - React Query + API integration (INT-012, INT-013, INT-014, INT-010)
  - Error handling integration (INT-015, INT-016, INT-017)
- All P0 priority test scenarios from test design document are covered
- Tests follow existing patterns from SearchInterface and UploadToSearch tests
- Proper mocking of API service using Vitest

### Improvements Checklist

- [x] Fixed `scrollIntoView` guard for test environment compatibility
- [x] Verified all acceptance criteria are implemented
- [x] Confirmed test coverage meets requirements
- [x] Verified responsive design implementation
- [x] Added integration tests for routing, API integration, and error handling (11 tests)
- [ ] Consider adding E2E tests for full user journey (future enhancement)

### Security Review

**Findings:**

- ✓ React automatically escapes user input in JSX (XSS protection)
- ✓ Input validation via `maxLength={1000}` attribute
- ✓ Error messages from API are displayed but don't expose sensitive information
- ⚠️ Note: Chat endpoint is public (MVP scope per story requirements) - acceptable for MVP but should be reviewed for production

**Recommendations:**

- No immediate security concerns for MVP scope
- For production, consider adding rate limiting and user authentication if needed

### Performance Considerations

**Findings:**

- ✓ Component uses React hooks efficiently (no unnecessary re-renders observed)
- ✓ Citations are sorted efficiently (simple array sort)
- ✓ Auto-scroll uses `scrollIntoView` with smooth behavior
- ⚠️ Note: Long conversation histories could impact performance (100+ messages) - acceptable for MVP, consider virtualization for future if needed

**Recommendations:**

- Performance is acceptable for MVP scope
- Monitor real-world usage for long conversations; consider message virtualization if performance degrades

### Files Modified During Review

**Files Reviewed:**

- `src/components/ChatInterface.tsx` - Main chat interface component (refactored scrollIntoView guard)
- `src/pages/ChatPage.tsx` - Chat page wrapper component
- `src/services/api.ts` - API service with chat function
- `src/App.tsx` - Routing configuration
- `src/components/Layout.tsx` - Navigation integration
- `src/tests/ChatInterface.test.tsx` - Comprehensive unit test suite (15 tests)
- `src/tests/integration/ChatIntegration.test.tsx` - Integration test suite (11 tests)
- `src/index.css` - Tailwind CSS utilities added

**Note**: No additional modifications needed beyond the scrollIntoView guard fix that was already applied during development.

### Gate Status

**Gate**: PASS → `docs/qa/gates/9.5-react-chat-ui.yml`

**Risk Profile**: `docs/qa/assessments/9.5-risk-20251104.md` (Risk Score: 85/100 - Lower Risk)

**Test Design**: `docs/qa/assessments/9.5-test-design-20251104.md` (32 test scenarios designed, 26 implemented: 15 unit + 11 integration)

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive tests passing, code quality excellent, no blocking issues identified. Story is ready for completion.

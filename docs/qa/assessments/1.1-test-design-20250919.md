# Test Design: Story 1.1

Date: 2024-12-19
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 45
- Unit tests: 20 (44%)
- Integration tests: 18 (40%)
- E2E tests: 7 (16%)
- Priority distribution: P0: 15, P1: 20, P2: 8, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: Support file upload for PDF, DOCX, TXT, MD formats (max 20MB)

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification             |
| ------------ | ----------- | -------- | ------------------------------------- | ------------------------- |
| 1.1-UNIT-001 | Unit        | P0       | Validate file type by MIME type       | Pure validation logic     |
| 1.1-UNIT-002 | Unit        | P0       | Validate file size limits             | Business rule validation  |
| 1.1-UNIT-003 | Unit        | P0       | Validate file extension vs MIME type  | Security validation       |
| 1.1-INT-001  | Integration | P0       | Upload endpoint processes valid files | API contract validation   |
| 1.1-INT-002  | Integration | P0       | Upload endpoint rejects invalid files | Error handling validation |
| 1.1-E2E-001  | E2E         | P1       | Complete file upload journey          | Critical user path        |

### AC2: Block scanned PDFs with clear error messaging

#### Scenarios

| ID           | Level       | Priority | Test                                   | Justification                  |
| ------------ | ----------- | -------- | -------------------------------------- | ------------------------------ |
| 1.1-UNIT-004 | Unit        | P0       | Detect scanned PDF by character count  | Algorithm validation           |
| 1.1-UNIT-005 | Unit        | P0       | Generate appropriate error messages    | Business logic validation      |
| 1.1-INT-003  | Integration | P0       | API returns blocked status for scanned | Service integration validation |
| 1.1-E2E-002  | E2E         | P1       | User sees clear error for scanned PDF  | User experience validation     |

### AC3: Provide 8 predefined chunking methods for selection

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification               |
| ------------ | ----------- | -------- | ------------------------------------ | --------------------------- |
| 1.1-UNIT-006 | Unit        | P1       | Validate chunking method enum values | Business rule validation    |
| 1.1-UNIT-007 | Unit        | P1       | Apply each chunking method to sample | Algorithm validation        |
| 1.1-INT-004  | Integration | P1       | API accepts valid chunking methods   | Service contract validation |
| 1.1-INT-005  | Integration | P1       | API rejects invalid chunking methods | Error handling validation   |

### AC4: Implement text preprocessing and normalization

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification                  |
| ------------ | ----------- | -------- | ------------------------------------ | ------------------------------ |
| 1.1-UNIT-008 | Unit        | P1       | Text extraction from PDF files       | Algorithm validation           |
| 1.1-UNIT-009 | Unit        | P1       | Text extraction from DOCX files      | Algorithm validation           |
| 1.1-UNIT-010 | Unit        | P1       | Text extraction from TXT/MD files    | Algorithm validation           |
| 1.1-UNIT-011 | Unit        | P1       | Text normalization and preprocessing | Business logic validation      |
| 1.1-INT-006  | Integration | P1       | Text extraction service integration  | Service integration validation |

### AC5: Generate embeddings using configurable provider/model

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                 |
| ------------ | ----------- | -------- | ------------------------------------- | ----------------------------- |
| 1.1-UNIT-012 | Unit        | P0       | Embedding generation with valid input | Algorithm validation          |
| 1.1-UNIT-013 | Unit        | P0       | Handle embedding provider errors      | Error handling validation     |
| 1.1-INT-007  | Integration | P0       | Embedding service with external API   | External service integration  |
| 1.1-INT-008  | Integration | P0       | Retry logic for embedding failures    | Resilience validation         |
| 1.1-E2E-003  | E2E         | P1       | End-to-end embedding generation       | Critical data flow validation |

### AC6: Store vectors in Qdrant with proper metadata

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                   |
| ------------ | ----------- | -------- | ----------------------------------- | ------------------------------- |
| 1.1-UNIT-014 | Unit        | P0       | Vector payload structure validation | Data structure validation       |
| 1.1-INT-009  | Integration | P0       | Qdrant collection creation          | Database integration validation |
| 1.1-INT-010  | Integration | P0       | Vector storage with metadata        | Database operation validation   |
| 1.1-INT-011  | Integration | P0       | Qdrant connection error handling    | Error handling validation       |

### AC7: Build and maintain lexical index for hybrid search

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                   |
| ------------ | ----------- | -------- | ----------------------------------- | ------------------------------- |
| 1.1-UNIT-015 | Unit        | P1       | tsvector generation for text chunks | Algorithm validation            |
| 1.1-INT-012  | Integration | P1       | Postgres FTS index creation         | Database integration validation |
| 1.1-INT-013  | Integration | P1       | FTS query execution                 | Database operation validation   |
| 1.1-INT-014  | Integration | P1       | GIN index performance               | Performance validation          |

### AC8: Provide real-time ingestion status updates

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                  |
| ------------ | ----------- | -------- | ------------------------------------- | ------------------------------ |
| 1.1-UNIT-016 | Unit        | P1       | Status state machine transitions      | Business logic validation      |
| 1.1-INT-015  | Integration | P1       | Status API endpoint functionality     | API contract validation        |
| 1.1-INT-016  | Integration | P1       | Status updates during processing      | Service integration validation |
| 1.1-E2E-004  | E2E         | P1       | User sees status updates in real-time | User experience validation     |

### AC9: Support ingestion of 200-300 pages within 20 minutes

#### Scenarios

| ID          | Level       | Priority | Test                                    | Justification               |
| ----------- | ----------- | -------- | --------------------------------------- | --------------------------- |
| 1.1-INT-017 | Integration | P0       | Performance test with 200-page document | Performance validation      |
| 1.1-INT-018 | Integration | P0       | Performance test with 300-page document | Performance validation      |
| 1.1-E2E-005 | E2E         | P1       | End-to-end performance validation       | Complete system performance |

## Risk Coverage

### SEC-001: File Upload Security Vulnerabilities

- **1.1-UNIT-001**: File type validation
- **1.1-UNIT-002**: File size validation
- **1.1-UNIT-003**: MIME type vs extension validation
- **1.1-INT-001**: Upload endpoint security
- **1.1-INT-002**: Error handling for malicious files

### PERF-001: Embedding Generation Performance Bottleneck

- **1.1-INT-007**: External API integration
- **1.1-INT-008**: Retry logic validation
- **1.1-E2E-003**: End-to-end performance
- **1.1-INT-017**: 200-page performance test
- **1.1-INT-018**: 300-page performance test

### DATA-001: Data Loss During Ingestion Process

- **1.1-INT-009**: Qdrant collection creation
- **1.1-INT-010**: Vector storage validation
- **1.1-INT-012**: Postgres FTS index creation
- **1.1-E2E-003**: End-to-end data flow
- **1.1-E2E-005**: Complete ingestion validation

### TECH-001: Complex Multi-Service Integration

- **1.1-INT-006**: Text extraction service
- **1.1-INT-007**: Embedding service integration
- **1.1-INT-009**: Qdrant integration
- **1.1-INT-012**: Postgres integration
- **1.1-E2E-003**: Multi-service data flow

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on critical logic)

   - 1.1-UNIT-001, 1.1-UNIT-002, 1.1-UNIT-003 (file validation)
   - 1.1-UNIT-004, 1.1-UNIT-005 (scanned PDF detection)
   - 1.1-UNIT-012, 1.1-UNIT-013 (embedding generation)
   - 1.1-UNIT-014 (vector payload validation)

2. **P0 Integration tests** (critical service interactions)

   - 1.1-INT-001, 1.1-INT-002 (upload endpoint)
   - 1.1-INT-003 (scanned PDF handling)
   - 1.1-INT-007, 1.1-INT-008 (embedding service)
   - 1.1-INT-009, 1.1-INT-010 (Qdrant storage)
   - 1.1-INT-011 (Qdrant error handling)
   - 1.1-INT-017, 1.1-INT-018 (performance tests)

3. **P0 E2E tests** (critical user journeys)

   - 1.1-E2E-001 (file upload journey)
   - 1.1-E2E-002 (scanned PDF error handling)
   - 1.1-E2E-003 (embedding generation)
   - 1.1-E2E-005 (performance validation)

4. **P1 tests** (core functionality)

   - All remaining P1 unit and integration tests
   - 1.1-E2E-004 (status updates)

5. **P2+ tests** (as time permits)
   - P2 and P3 tests for completeness

## Test Data Requirements

### File Test Data

- **Valid files**: Sample PDF, DOCX, TXT, MD files (various sizes)
- **Invalid files**: Malicious files, oversized files, corrupted files
- **Scanned PDFs**: PDFs with <20 characters per page
- **Large files**: 200-300 page documents for performance testing

### Database Test Data

- **Test documents**: Pre-created document records
- **Test chunks**: Sample chunk data with metadata
- **Test vectors**: Sample embedding vectors for Qdrant

### API Test Data

- **Valid requests**: Properly formatted upload requests
- **Invalid requests**: Malformed requests, missing parameters
- **Error scenarios**: Network failures, service timeouts

## Test Environment Requirements

### Unit Tests

- **No external dependencies**
- **Mock all external services**
- **Fast execution (<1 second per test)**

### Integration Tests

- **Test database**: In-memory or containerized Postgres
- **Test Qdrant**: Containerized Qdrant instance
- **Mock external APIs**: Embedding provider mocks
- **Test file storage**: Local or in-memory storage

### E2E Tests

- **Full environment**: All services running
- **Test data**: Pre-populated test documents
- **Performance monitoring**: Metrics collection enabled
- **Error simulation**: Network failure simulation tools

## Test Automation Strategy

### Continuous Integration

- **Unit tests**: Run on every commit
- **Integration tests**: Run on pull requests
- **E2E tests**: Run on main branch merges
- **Performance tests**: Run nightly

### Test Reporting

- **Coverage reports**: Unit test coverage >90% for P0
- **Performance reports**: Response time tracking
- **Security reports**: Vulnerability scanning results
- **Failure analysis**: Root cause analysis for test failures

## Quality Gates

### Must Pass Before Deployment

- All P0 tests passing
- Unit test coverage >90% for critical components
- Performance tests meeting 20-minute target
- Security tests passing (no high/critical vulnerabilities)

### Should Pass Before Deployment

- All P1 tests passing
- Integration test coverage >80%
- E2E test coverage for critical paths
- Error handling tests passing

### Nice to Have

- All P2+ tests passing
- 100% test coverage
- Performance optimization tests
- Load testing results

## Maintenance Strategy

### Test Updates

- **Update tests** when requirements change
- **Add tests** for new edge cases discovered
- **Remove tests** for deprecated functionality
- **Refactor tests** for better maintainability

### Test Monitoring

- **Track test execution time** and optimize slow tests
- **Monitor test flakiness** and fix unstable tests
- **Analyze test failures** for patterns and root causes
- **Review test coverage** regularly for gaps

## Conclusion

This test design provides comprehensive coverage for Story 1.1 with 45 test scenarios across all levels. The focus on P0 tests ensures critical functionality is thoroughly validated, while the risk-based approach addresses the identified security and performance concerns. The recommended execution order prioritizes fast feedback on critical issues while maintaining thorough coverage of the complete ingestion pipeline.

# Test Design: Story 12.3

Date: 2025-11-24
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 73
- **Unit tests**: 35 (48%)
- **Integration tests**: 34 (47%)
- **E2E tests**: 4 (5%)
- **Priority distribution**: P0: 16, P1: 18, P2: 8

**Strategy Rationale:**
This story introduces intelligent query augmentation for follow-up questions, requiring comprehensive testing at multiple levels. Unit tests focus on helper method logic (section ID extraction, ambiguous detection, history parsing, query building). Integration tests verify API route changes, HybridSearchService integration, and end-to-end retrieval flow. E2E tests validate critical user journeys. High priority (P0) assigned to risks identified in risk profile (TECH-001, TECH-002, BUS-001, BUS-002) and core functionality that affects retrieval accuracy.

## Test Scenarios by Acceptance Criteria

### AC1: ChatOrchestrator helper `_extract_section_id()` implemented to detect section ID patterns (e.g., 5.22.3) in text

#### Scenarios

| ID            | Level       | Priority | Test                                                     | Justification                   | Mitigates Risks |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------- | --------------- |
| 12.3-UNIT-001 | Unit        | P0       | Extract "5.22.3" from "what's in section 5.22.3"         | Core functionality, pure logic  | TECH-002        |
| 12.3-UNIT-002 | Unit        | P0       | Extract "1.2" from "explain section 1.2"                 | Core functionality, pure logic  | TECH-002        |
| 12.3-UNIT-003 | Unit        | P0       | Extract "10.5.3.2" from complex section IDs              | Edge case handling              | TECH-002        |
| 12.3-UNIT-004 | Unit        | P1       | Return None for text without section IDs                 | Negative case validation        | TECH-002        |
| 12.3-UNIT-005 | Unit        | P1       | Extract first section ID when multiple present           | Edge case handling              | TECH-002        |
| 12.3-UNIT-006 | Unit        | P2       | Handle section IDs in URLs (should not match)            | Edge case, false positive check | TECH-002        |
| 12.3-UNIT-007 | Unit        | P2       | Handle version numbers like "1.2.3" (should match)       | Edge case, pattern validation   | TECH-002        |
| 12.3-INT-001  | Integration | P1       | Extracted section ID matches HybridSearchService pattern | Consistency verification        | TECH-002        |

### AC2: ChatOrchestrator helper `_is_ambiguous_followup()` implemented to detect short queries with pronouns/phrases that lack explicit section IDs

#### Scenarios

| ID            | Level | Priority | Test                                                                   | Justification                  | Mitigates Risks   |
| ------------- | ----- | -------- | ---------------------------------------------------------------------- | ------------------------------ | ----------------- |
| 12.3-UNIT-008 | Unit  | P0       | "what do I need to submit for this?" → True                            | Core functionality, pure logic | TECH-001          |
| 12.3-UNIT-009 | Unit  | P0       | "what are the indicators for it?" → True                               | Core functionality, pure logic | TECH-001          |
| 12.3-UNIT-010 | Unit  | P0       | "explain section 5.22.3" → False (explicit section)                    | Core functionality, pure logic | TECH-001, BUS-001 |
| 12.3-UNIT-011 | Unit  | P0       | "give me an overview of the framework" → False (no pronouns, longer)   | Core functionality, pure logic | TECH-001, BUS-002 |
| 12.3-UNIT-012 | Unit  | P1       | "what is the evidence for this section?" → False (contains section ID) | Edge case validation           | TECH-001, BUS-001 |
| 12.3-UNIT-013 | Unit  | P1       | Query exactly 80 characters with pronoun → False (length threshold)    | Boundary condition             | TECH-001          |
| 12.3-UNIT-014 | Unit  | P1       | Query 79 characters with pronoun → True (length threshold)             | Boundary condition             | TECH-001          |
| 12.3-UNIT-015 | Unit  | P1       | Query with "for this" phrase → True                                    | Phrase detection               | TECH-001          |
| 12.3-UNIT-016 | Unit  | P1       | Query with "for that" phrase → True                                    | Phrase detection               | TECH-001          |
| 12.3-UNIT-017 | Unit  | P2       | Query with "them" pronoun → True                                       | Pronoun detection              | TECH-001          |
| 12.3-UNIT-018 | Unit  | P2       | Query with "those" pronoun → True                                      | Pronoun detection              | TECH-001          |
| 12.3-UNIT-019 | Unit  | P2       | Very long query (>200 chars) with pronoun → False                      | Length threshold validation    | TECH-001          |

### AC3: ChatOrchestrator helper `_get_last_section_id_from_history()` implemented to find the most recent section ID from chat history

#### Scenarios

| ID            | Level | Priority | Test                                                                    | Justification                  | Mitigates Risks |
| ------------- | ----- | -------- | ----------------------------------------------------------------------- | ------------------------------ | --------------- |
| 12.3-UNIT-020 | Unit  | P0       | History with section ID in last user message → returns section ID       | Core functionality, pure logic | DATA-001        |
| 12.3-UNIT-021 | Unit  | P0       | History with section ID in earlier user message → returns most recent   | Core functionality, pure logic | DATA-001        |
| 12.3-UNIT-022 | Unit  | P1       | History without section IDs → returns None                              | Negative case validation       | DATA-001        |
| 12.3-UNIT-023 | Unit  | P1       | Empty history → returns None                                            | Edge case handling             | DATA-001        |
| 12.3-UNIT-024 | Unit  | P1       | History with only assistant messages → returns None                     | Edge case handling             | DATA-001        |
| 12.3-UNIT-025 | Unit  | P1       | History with multiple section IDs → returns most recent                 | Core functionality, pure logic | DATA-001        |
| 12.3-UNIT-026 | Unit  | P2       | History with section ID in middle of conversation → returns most recent | Edge case validation           | DATA-001        |

### AC4: ChatOrchestrator helper `_build_retrieval_query()` implemented to augment ambiguous follow-up queries with section context from history

#### Scenarios

| ID            | Level       | Priority | Test                                                                  | Justification                  | Mitigates Risks   |
| ------------- | ----------- | -------- | --------------------------------------------------------------------- | ------------------------------ | ----------------- |
| 12.3-UNIT-027 | Unit        | P0       | Current message has explicit section ID → returns unchanged           | Core functionality, pure logic | BUS-001           |
| 12.3-UNIT-028 | Unit        | P0       | Non-ambiguous query → returns unchanged                               | Core functionality, pure logic | BUS-002           |
| 12.3-UNIT-029 | Unit        | P0       | Ambiguous follow-up with history section ID → returns augmented query | Core functionality, pure logic | TECH-001, BUS-001 |
| 12.3-UNIT-030 | Unit        | P0       | Ambiguous follow-up without history section ID → returns unchanged    | Core functionality, pure logic | BUS-002           |
| 12.3-UNIT-031 | Unit        | P1       | Augmented query format: "For section {id}, {original}"                | Output format validation       | TECH-001          |
| 12.3-UNIT-032 | Unit        | P1       | Multiple ambiguous follow-ups in sequence → uses most recent section  | Edge case validation           | DATA-001          |
| 12.3-INT-002  | Integration | P1       | \_build_retrieval_query integrates with other helpers                 | Component interaction          | TECH-001          |

### AC5: Chat API route updated to use augmented retrieval query for retrieval while preserving original user message for LLM

#### Scenarios

| ID           | Level       | Priority | Test                                                           | Justification                     | Mitigates Risks |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | --------------------------------- | --------------- |
| 12.3-INT-003 | Integration | P0       | API route loads history before retrieval                       | API route flow verification       | PERF-001        |
| 12.3-INT-004 | Integration | P0       | API route builds retrieval query using \_build_retrieval_query | API route flow verification       | TECH-001        |
| 12.3-INT-005 | Integration | P0       | API route uses retrieval_query for retrieve_candidates()       | API route flow verification       | TECH-001        |
| 12.3-INT-006 | Integration | P0       | API route uses original message for rerank() and chat()        | Message preservation verification | AC7             |
| 12.3-INT-007 | Integration | P1       | API route handles missing session_id gracefully                | Error handling                    | TECH-003        |
| 12.3-INT-008 | Integration | P1       | API route logs augmentation decisions (INFO level)             | Observability                     | OPS-001         |
| 12.3-INT-009 | Integration | P2       | API route performance with history loading                     | Performance validation            | PERF-001        |

### AC6: Retrieval query augmentation only applies when current message is ambiguous and history contains a section ID

#### Scenarios

| ID           | Level       | Priority | Test                                                        | Justification        | Mitigates Risks |
| ------------ | ----------- | -------- | ----------------------------------------------------------- | -------------------- | --------------- |
| 12.3-INT-010 | Integration | P0       | Augmentation only occurs for ambiguous follow-ups           | Core business logic  | BUS-001         |
| 12.3-INT-011 | Integration | P0       | Augmentation requires history with section ID               | Core business logic  | BUS-002         |
| 12.3-INT-012 | Integration | P0       | Explicit section IDs in current message bypass augmentation | Core business logic  | BUS-001         |
| 12.3-INT-013 | Integration | P0       | Non-ambiguous queries bypass augmentation                   | Core business logic  | BUS-002         |
| 12.3-INT-014 | Integration | P1       | First message in session (no history) → no augmentation     | Edge case validation | TECH-003        |
| 12.3-INT-015 | Integration | P1       | History without section IDs → no augmentation               | Edge case validation | BUS-002         |

### AC7: Original user message always passed to LLM (retrieval query augmentation is transparent to user)

#### Scenarios

| ID           | Level       | Priority | Test                                                        | Justification                     | Mitigates Risks |
| ------------ | ----------- | -------- | ----------------------------------------------------------- | --------------------------------- | --------------- |
| 12.3-INT-016 | Integration | P0       | LLM receives original user message (not augmented query)    | Message preservation verification | AC7             |
| 12.3-INT-017 | Integration | P0       | Chat history saves original user message                    | Data integrity verification       | AC7             |
| 12.3-INT-018 | Integration | P1       | User sees original message in conversation                  | User experience verification      | AC7             |
| 12.3-E2E-001 | E2E         | P1       | User sends ambiguous follow-up, sees original message in UI | Critical user journey             | AC7             |

### AC8: Existing section-ID direct path in HybridSearchService continues to work unchanged

#### Scenarios

| ID           | Level       | Priority | Test                                                     | Justification                   | Mitigates Risks    |
| ------------ | ----------- | -------- | -------------------------------------------------------- | ------------------------------- | ------------------ |
| 12.3-INT-019 | Integration | P0       | Augmented query triggers section-ID direct path          | HybridSearchService integration | TECH-004           |
| 12.3-INT-020 | Integration | P0       | Correct chunks retrieved for section from history        | Retrieval accuracy verification | TECH-004, DATA-001 |
| 12.3-INT-021 | Integration | P0       | Existing section-ID queries continue to work             | Regression prevention           | TECH-004           |
| 12.3-INT-022 | Integration | P1       | Augmented query format matches HybridSearchService regex | Format compatibility            | TECH-004           |
| 12.3-E2E-002 | E2E         | P1       | User asks section question, gets correct chunks          | Critical user journey           | TECH-004           |

### AC9: No changes to public API routes or request/response schemas

#### Scenarios

| ID           | Level       | Priority | Test                                         | Justification                  | Mitigates Risks |
| ------------ | ----------- | -------- | -------------------------------------------- | ------------------------------ | --------------- |
| 12.3-INT-023 | Integration | P0       | ChatRequest schema unchanged                 | API compatibility verification | AC9             |
| 12.3-INT-024 | Integration | P0       | ChatResponse schema unchanged                | API compatibility verification | AC9             |
| 12.3-INT-025 | Integration | P0       | API endpoint paths unchanged                 | API compatibility verification | AC9             |
| 12.3-INT-026 | Integration | P1       | Backward compatibility with existing clients | Regression prevention          | AC9             |
| 12.3-E2E-003 | E2E         | P2       | Existing client code continues to work       | User experience verification   | AC9             |

### AC10: Existing multi-turn chat history mechanism (ChatSession/ChatMessage) remains intact

#### Scenarios

| ID           | Level       | Priority | Test                                          | Justification              | Mitigates Risks |
| ------------ | ----------- | -------- | --------------------------------------------- | -------------------------- | --------------- |
| 12.3-INT-027 | Integration | P0       | ChatSession/ChatMessage models unchanged      | Data model verification    | AC10            |
| 12.3-INT-028 | Integration | P0       | load_history() continues to work              | Functionality verification | AC10            |
| 12.3-INT-029 | Integration | P0       | save_turn() continues to work                 | Functionality verification | AC10            |
| 12.3-INT-030 | Integration | P1       | conversation_id/session_id handling unchanged | Regression prevention      | AC10            |

### AC11: Unit tests for all helper methods

#### Scenarios

| ID            | Level | Priority | Test                                       | Justification              | Mitigates Risks |
| ------------- | ----- | -------- | ------------------------------------------ | -------------------------- | --------------- |
| 12.3-UNIT-033 | Unit  | P0       | All helper methods have unit test coverage | Test coverage verification | AC11            |
| 12.3-UNIT-034 | Unit  | P1       | Helper methods handle edge cases correctly | Edge case coverage         | AC11            |

### AC12: Integration test verifying ambiguous follow-up correctly retrieves chunks from previous section context

#### Scenarios

| ID           | Level       | Priority | Test                                                                                                  | Justification                     | Mitigates Risks |
| ------------ | ----------- | -------- | ----------------------------------------------------------------------------------------------------- | --------------------------------- | --------------- |
| 12.3-INT-031 | Integration | P0       | Turn 1: "what's in section 5.22.3" → successful retrieval                                             | End-to-end flow verification      | AC12            |
| 12.3-INT-032 | Integration | P0       | Turn 2: "what do I need to submit for this?" → HybridSearchService receives query containing "5.22.3" | End-to-end flow verification      | AC12, TECH-001  |
| 12.3-INT-033 | Integration | P0       | Correct chunks retrieved for section 5.22.3                                                           | Retrieval accuracy verification   | AC12, DATA-001  |
| 12.3-INT-034 | Integration | P0       | LLM receives original message "what do I need to submit for this?"                                    | Message preservation verification | AC12, AC7       |
| 12.3-E2E-004 | E2E         | P0       | User completes multi-turn conversation with ambiguous follow-up                                       | Critical user journey             | AC12, TECH-001  |

## Risk Coverage

### TECH-001: Ambiguous Follow-up Detection Accuracy (High Risk)

**Covered by:**

- 12.3-UNIT-008 through 12.3-UNIT-019 (detection logic)
- 12.3-UNIT-027 through 12.3-UNIT-032 (query building)
- 12.3-INT-010 through 12.3-INT-015 (augmentation logic)
- 12.3-INT-031 through 12.3-INT-034 (end-to-end flow)
- 12.3-E2E-004 (user journey)

**Test Focus:**

- False positive/negative detection
- Edge cases and boundary conditions
- Integration with query building
- End-to-end accuracy validation

### TECH-002: Regex Pattern Matching Edge Cases (Medium Risk)

**Covered by:**

- 12.3-UNIT-001 through 12.3-UNIT-007 (extraction logic)
- 12.3-INT-001 (consistency with HybridSearchService)

**Test Focus:**

- Various section ID formats
- Edge cases (URLs, version numbers)
- Consistency with existing implementation

### TECH-003: History Loading Failures (Low Risk)

**Covered by:**

- 12.3-INT-007 (error handling)
- 12.3-INT-014 (no history scenario)

**Test Focus:**

- Graceful error handling
- Missing session scenarios

### TECH-004: HybridSearchService Integration Issues (Low Risk)

**Covered by:**

- 12.3-INT-019 through 12.3-INT-022 (integration verification)
- 12.3-E2E-002 (user journey)

**Test Focus:**

- Augmented query format compatibility
- Section-ID direct path triggering
- Regression prevention

### PERF-001: History Loading Latency (Medium Risk)

**Covered by:**

- 12.3-INT-003 (history loading)
- 12.3-INT-009 (performance validation)

**Test Focus:**

- Latency measurement
- Performance impact assessment

### BUS-001: False Positives in Query Augmentation (Medium Risk)

**Covered by:**

- 12.3-UNIT-010, 12.3-UNIT-012 (explicit section bypass)
- 12.3-UNIT-027 (explicit section handling)
- 12.3-INT-010, 12.3-INT-012 (augmentation logic)

**Test Focus:**

- Queries that should NOT be augmented
- Explicit section ID detection
- Inappropriate augmentation prevention

### BUS-002: False Negatives in Query Augmentation (Medium Risk)

**Covered by:**

- 12.3-UNIT-011 (non-ambiguous detection)
- 12.3-UNIT-028 (non-ambiguous handling)
- 12.3-INT-011, 12.3-INT-013, 12.3-INT-015 (augmentation logic)

**Test Focus:**

- Queries that should be augmented
- History requirements
- Missed augmentation scenarios

### DATA-001: Wrong Section ID from History (Medium Risk)

**Covered by:**

- 12.3-UNIT-020, 12.3-UNIT-021, 12.3-UNIT-025 (history parsing)
- 12.3-INT-020, 12.3-INT-033 (retrieval accuracy)

**Test Focus:**

- Most recent section ID selection
- Multiple section ID scenarios
- Correct chunk retrieval

### OPS-001: Debugging Difficulty (Low Risk)

**Covered by:**

- 12.3-INT-008 (logging verification)

**Test Focus:**

- Logging comprehensiveness
- Debug information availability

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

1. **Helper Method Core Logic** (12.3-UNIT-001 through 12.3-UNIT-032)
   - Section ID extraction
   - Ambiguous detection
   - History parsing
   - Query building

**Rationale:** Fast feedback on core logic, catch bugs early

### Phase 2: P0 Integration Tests (Critical Paths)

2. **API Route Flow** (12.3-INT-003 through 12.3-INT-006)

   - History loading
   - Query building
   - Message preservation

3. **Augmentation Logic** (12.3-INT-010 through 12.3-INT-015)

   - When augmentation occurs
   - When augmentation is bypassed

4. **HybridSearchService Integration** (12.3-INT-019 through 12.3-INT-022)

   - Augmented query compatibility
   - Section-ID direct path
   - Regression prevention

5. **End-to-End Flow** (12.3-INT-031 through 12.3-INT-034)

   - Multi-turn conversation
   - Retrieval accuracy
   - Message preservation

6. **API Compatibility** (12.3-INT-023 through 12.3-INT-026)

   - Schema verification
   - Backward compatibility

7. **Chat History Mechanism** (12.3-INT-027 through 12.3-INT-030)
   - Model verification
   - Functionality preservation

### Phase 3: P0 E2E Tests (User Journeys)

8. **Critical User Journeys** (12.3-E2E-001, 12.3-E2E-002, 12.3-E2E-004)
   - Message preservation
   - Section retrieval
   - Multi-turn conversation

### Phase 4: P1 Tests (Core Functionality)

9. **Edge Cases and Error Handling** (P1 unit and integration tests)
   - Boundary conditions
   - Error scenarios
   - Edge case validation

### Phase 5: P2 Tests (Nice to Have)

10. **Additional Coverage** (P2 tests)
    - Extended edge cases
    - Performance validation
    - Additional compatibility checks

## Test Coverage Summary

### By Acceptance Criteria

| AC   | Unit Tests | Integration Tests | E2E Tests | Total | Coverage |
| ---- | ---------- | ----------------- | --------- | ----- | -------- |
| AC1  | 8          | 1                 | 0         | 9     | Complete |
| AC2  | 12         | 0                 | 0         | 12    | Complete |
| AC3  | 7          | 0                 | 0         | 7     | Complete |
| AC4  | 6          | 1                 | 0         | 7     | Complete |
| AC5  | 0          | 7                 | 0         | 7     | Complete |
| AC6  | 0          | 6                 | 0         | 6     | Complete |
| AC7  | 0          | 3                 | 1         | 4     | Complete |
| AC8  | 0          | 4                 | 1         | 5     | Complete |
| AC9  | 0          | 4                 | 1         | 5     | Complete |
| AC10 | 0          | 4                 | 0         | 4     | Complete |
| AC11 | 2          | 0                 | 0         | 2     | Complete |
| AC12 | 0          | 4                 | 1         | 5     | Complete |

### By Test Level

- **Unit Tests**: 35 scenarios (83% of total)
- **Integration Tests**: 34 scenarios (81% of total)
- **E2E Tests**: 4 scenarios (10% of total)

### By Priority

- **P0 Tests**: 16 scenarios (38%) - Critical functionality
- **P1 Tests**: 18 scenarios (43%) - Core functionality
- **P2 Tests**: 8 scenarios (19%) - Edge cases and optimizations

## Test Environment Requirements

### Unit Tests

- **Framework**: pytest
- **Dependencies**: None (pure logic testing)
- **Mocking**: Not required for helper methods
- **Execution Time**: < 1 second for all unit tests

### Integration Tests

- **Framework**: pytest with FastAPI TestClient
- **Dependencies**:
  - Test database (SQLite or PostgreSQL test instance)
  - Mock HybridSearchService (to capture query strings)
  - Mock DeepSeek client (for LLM calls)
- **Execution Time**: < 30 seconds for all integration tests

### E2E Tests

- **Framework**: pytest with FastAPI TestClient
- **Dependencies**:
  - Full test environment
  - Test database with sample documents
  - Mock DeepSeek client
- **Execution Time**: < 2 minutes for all E2E tests

## Test Data Requirements

### Unit Tests

- Sample queries (ambiguous and non-ambiguous)
- Sample section IDs (various formats)
- Sample history messages (with and without section IDs)
- Edge case inputs (empty strings, None, special characters)

### Integration Tests

- Test chat sessions with history
- Test documents with section IDs
- Mock HybridSearchService responses
- Mock LLM responses

### E2E Tests

- Complete test database with sample documents
- Test sessions with conversation history
- Realistic query scenarios

## Success Criteria

### Test Execution

- All P0 tests must pass before deployment
- All P1 tests must pass before production release
- P2 tests should pass but can be deferred if needed

### Coverage Metrics

- Unit test coverage: > 90% for helper methods
- Integration test coverage: > 80% for API routes
- E2E test coverage: All critical user journeys

### Quality Gates

- No P0 test failures
- < 5% P1 test failures (acceptable for known issues)
- All risk mitigation tests passing
- Performance tests within acceptable thresholds

## Notes

- Helper methods are private (prefixed with `_`), so unit tests may need to use reflection or test through public methods
- Integration tests should mock HybridSearchService.search() to capture query strings for verification
- E2E tests should verify end-to-end flow but can use mocks for external services (DeepSeek)
- Performance tests (12.3-INT-009) should measure latency impact of history loading
- All tests should follow existing test patterns from Stories 12.1 and 12.2

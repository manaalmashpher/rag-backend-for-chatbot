# Test Design: Story 9.3

Date: 2025-11-02
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 32
- **Unit tests**: 11 (34%)
- **Integration tests**: 17 (53%)
- **E2E tests**: 4 (13%)
- **Priority distribution**: P0: 14, P1: 12, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Chat API route (`app/api/routes/chat.py`) with POST /api/chat endpoint

#### Scenarios

| ID           | Level       | Priority | Test                               | Justification                                     |
| ------------ | ----------- | -------- | ---------------------------------- | ------------------------------------------------- |
| 9.3-UNIT-001 | Unit        | P0       | Router creation and configuration  | Pure logic validation, fast feedback              |
| 9.3-INT-001  | Integration | P0       | Endpoint registration in main app  | Tests router integration with FastAPI application |
| 9.3-INT-002  | Integration | P1       | POST /api/chat endpoint accessible | Validates endpoint is properly mounted            |

**Justifications:**

- **9.3-UNIT-001**: Unit test for router instantiation and basic structure
- **9.3-INT-001**: Integration test to verify router is included in main app with correct prefix/tags
- **9.3-INT-002**: Integration test to verify endpoint path is correct

### AC2: Request schema: `{ "conversation_id": string, "message": string }`

#### Scenarios

| ID           | Level       | Priority | Test                                        | Justification                               |
| ------------ | ----------- | -------- | ------------------------------------------- | ------------------------------------------- |
| 9.3-UNIT-002 | Unit        | P0       | ChatRequest schema validation (valid input) | Pure Pydantic validation logic              |
| 9.3-UNIT-003 | Unit        | P0       | ChatRequest UUID validation                 | Pure validation logic for UUID format       |
| 9.3-UNIT-004 | Unit        | P0       | ChatRequest message length validation       | Pure validation logic (1-1000 characters)   |
| 9.3-INT-003  | Integration | P0       | Invalid conversation_id returns 400         | Tests validation error handling in endpoint |
| 9.3-INT-004  | Integration | P0       | Invalid message length returns 400          | Tests validation error handling in endpoint |

**Justifications:**

- **9.3-UNIT-002/003/004**: Unit tests for Pydantic schema validation logic
- **9.3-INT-003/004**: Integration tests for validation errors in actual endpoint context

### AC3: Response schema: `{ "answer": string, "citations": array }`

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                                 |
| ------------ | ----------- | -------- | ------------------------------------- | --------------------------------------------- |
| 9.3-UNIT-005 | Unit        | P0       | ChatResponse schema validation        | Pure Pydantic response schema validation      |
| 9.3-UNIT-006 | Unit        | P1       | Response formatting from orchestrator | Tests data transformation logic               |
| 9.3-INT-005  | Integration | P0       | Successful response matches schema    | Validates response format in endpoint context |
| 9.3-INT-006  | Integration | P1       | Citations array structure validation  | Tests citation array formatting               |

**Justifications:**

- **9.3-UNIT-005/006**: Unit tests for response schema and transformation logic
- **9.3-INT-005/006**: Integration tests verify response format in actual API context

### AC4: Integration with existing chat orchestrator service (no changes required)

#### Scenarios

| ID           | Level       | Priority | Test                                              | Justification                                    |
| ------------ | ----------- | -------- | ------------------------------------------------- | ------------------------------------------------ |
| 9.3-UNIT-007 | Unit        | P0       | Mock orchestrator integration                     | Tests orchestrator method calls without external |
| 9.3-INT-007  | Integration | P0       | Endpoint calls orchestrator correctly             | Tests service integration boundary               |
| 9.3-INT-008  | Integration | P1       | Orchestrator flow: retrieve → rerank → synthesize | Tests complete orchestrator integration          |

**Justifications:**

- **9.3-UNIT-007**: Unit test with mocked orchestrator to test integration logic
- **9.3-INT-007/008**: Integration tests verify actual orchestrator integration

### AC5: Proper error handling with standardized error responses

#### Scenarios

| ID           | Level       | Priority | Test                                       | Justification                                  |
| ------------ | ----------- | -------- | ------------------------------------------ | ---------------------------------------------- |
| 9.3-UNIT-008 | Unit        | P0       | Error response formatting                  | Tests error model compliance logic             |
| 9.3-INT-009  | Integration | P0       | Orchestrator RuntimeError returns 500      | Tests error handling from service failures     |
| 9.3-INT-010  | Integration | P1       | Error response follows standardized format | Validates error model in endpoint context      |
| 9.3-E2E-001  | E2E         | P1       | Error responses visible to client          | Validates error handling in real user scenario |

**Justifications:**

- **9.3-UNIT-008**: Unit test for error formatting logic
- **9.3-INT-009/010**: Integration tests for error handling at endpoint level
- **9.3-E2E-001**: E2E test validates error responses in real scenario

### AC6: Request validation and sanitization

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                            |
| ------------ | ----------- | -------- | --------------------------------- | ---------------------------------------- |
| 9.3-UNIT-009 | Unit        | P1       | Input sanitization logic          | Tests sanitization function behavior     |
| 9.3-INT-011  | Integration | P1       | Malicious input sanitization      | Tests sanitization in endpoint context   |
| 9.3-INT-012  | Integration | P2       | Prompt injection attempt handling | Tests security validation (SEC-002 risk) |

**Justifications:**

- **9.3-UNIT-009**: Unit test for sanitization logic
- **9.3-INT-011/012**: Integration tests for security-related validation

### AC7: Rate limiting integration (handled by existing middleware)

#### Scenarios

| ID          | Level       | Priority | Test                                         | Justification                                 |
| ----------- | ----------- | -------- | -------------------------------------------- | --------------------------------------------- |
| 9.3-INT-013 | Integration | P0       | Rate limiting middleware applies to endpoint | Tests middleware integration (SEC-001 risk)   |
| 9.3-INT-014 | Integration | P1       | Rate limit exceeded returns 429              | Tests rate limiting behavior                  |
| 9.3-E2E-002 | E2E         | P2       | Multiple rapid requests trigger rate limit   | Validates rate limiting in realistic scenario |

**Justifications:**

- **9.3-INT-013/014**: Integration tests for middleware behavior
- **9.3-E2E-002**: E2E test for realistic rate limiting scenario

### AC8: Logging for chat interactions

#### Scenarios

| ID           | Level       | Priority | Test                       | Justification                      |
| ------------ | ----------- | -------- | -------------------------- | ---------------------------------- |
| 9.3-UNIT-010 | Unit        | P2       | Logging calls verification | Tests logging implementation       |
| 9.3-INT-015  | Integration | P1       | Request/response logging   | Tests logging in endpoint context  |
| 9.3-INT-016  | Integration | P2       | Error logging              | Tests error logging (OPS-001 risk) |

**Justifications:**

- **9.3-UNIT-010**: Unit test for logging calls
- **9.3-INT-015/016**: Integration tests verify logging in actual context

### AC9: No user authentication required (MVP scope - public endpoint)

#### Scenarios

| ID          | Level       | Priority | Test                              | Justification                            |
| ----------- | ----------- | -------- | --------------------------------- | ---------------------------------------- |
| 9.3-INT-017 | Integration | P1       | Endpoint accessible without auth  | Validates public endpoint behavior       |
| 9.3-E2E-003 | E2E         | P2       | Chat works without authentication | Validates public access in real scenario |

**Justifications:**

- **9.3-INT-017**: Integration test verifies no auth requirement
- **9.3-E2E-003**: E2E test validates public access works correctly

### AC10: No streaming (simple request/response)

#### Scenarios

| ID           | Level | Priority | Test                                      | Justification                          |
| ------------ | ----- | -------- | ----------------------------------------- | -------------------------------------- |
| 9.3-UNIT-011 | Unit  | P2       | Response is not streamed                  | Tests response format                  |
| 9.3-E2E-004  | E2E   | P1       | Complete response in single HTTP response | Validates simple request/response flow |

**Justifications:**

- **9.3-UNIT-011**: Unit test for response format
- **9.3-E2E-004**: E2E test validates complete response delivery

## Risk Coverage

### High Risks (Score 6)

**SEC-001: Public Endpoint Abuse Potential**

- Covered by: 9.3-INT-013, 9.3-INT-014, 9.3-E2E-002 (rate limiting tests)
- Additional coverage: Load testing recommended post-implementation

**TECH-001: Service Dependency Chain Failures**

- Covered by: 9.3-INT-009, 9.3-INT-010, 9.3-E2E-001 (error handling tests)
- Additional coverage: 9.3-INT-008 verifies complete orchestrator flow

**PERF-001: Sequential Service Calls Cause High Latency**

- Covered by: 9.3-E2E-004 (complete flow validation)
- Additional coverage: Performance/load testing recommended post-implementation

### Medium Risks (Score 4)

**SEC-002: Input Sanitization and Validation**

- Covered by: 9.3-UNIT-009, 9.3-INT-011, 9.3-INT-012 (sanitization tests)

**TECH-002: UUID and Schema Validation**

- Covered by: 9.3-UNIT-002, 9.3-UNIT-003, 9.3-UNIT-004, 9.3-INT-003, 9.3-INT-004 (validation tests)

**DATA-001: User Input Logging and Privacy**

- Covered by: 9.3-UNIT-010, 9.3-INT-015, 9.3-INT-016 (logging tests)
- Note: Verify logs don't capture full user messages (manual review)

**PERF-002: DeepSeek API Rate Limiting**

- Covered by: 9.3-INT-009 (error handling for service failures)
- Additional coverage: Mock DeepSeek rate limit responses in integration tests

**OPS-001: Missing Operational Monitoring**

- Covered by: 9.3-UNIT-010, 9.3-INT-015, 9.3-INT-016 (logging tests)
- Note: Metrics collection testing recommended post-implementation

**TECH-003: Response Schema Transformation**

- Covered by: 9.3-UNIT-006, 9.3-INT-005, 9.3-INT-006 (response formatting tests)

## Test Scenario Details

### Unit Tests (12 scenarios)

#### 9.3-UNIT-001: Router creation and configuration

**Priority**: P0  
**Component**: `app/api/routes/chat.py`  
**Test**: Verify APIRouter instance is created correctly, has correct tags  
**Mock Requirements**: None  
**Assertions**: Router instance exists, has proper configuration

#### 9.3-UNIT-002: ChatRequest schema validation (valid input)

**Priority**: P0  
**Component**: `app/schemas/chat.py`  
**Test**: Create ChatRequest with valid UUID and message, verify no validation errors  
**Mock Requirements**: None  
**Assertions**: Schema accepts valid input, fields are correctly typed

#### 9.3-UNIT-003: ChatRequest UUID validation

**Priority**: P0  
**Component**: `app/schemas/chat.py`  
**Test**: Attempt to create ChatRequest with invalid UUID format, verify ValidationError  
**Mock Requirements**: None  
**Assertions**: Invalid UUID raises ValidationError with clear message

#### 9.3-UNIT-004: ChatRequest message length validation

**Priority**: P0  
**Component**: `app/schemas/chat.py`  
**Test**: Test message length boundaries (empty, 1 char, 1000 chars, 1001 chars)  
**Mock Requirements**: None  
**Assertions**: Valid lengths accepted, invalid lengths raise ValidationError

#### 9.3-UNIT-005: ChatResponse schema validation

**Priority**: P0  
**Component**: `app/schemas/chat.py`  
**Test**: Create ChatResponse with all required fields, verify schema validation  
**Mock Requirements**: None  
**Assertions**: Schema validates correctly, all fields are properly typed

#### 9.3-UNIT-006: Response formatting from orchestrator

**Priority**: P1  
**Component**: `app/api/routes/chat.py`  
**Test**: Transform orchestrator response (answer + chunks) into ChatResponse format  
**Mock Requirements**: Mock orchestrator return values  
**Assertions**: Citations array correctly formatted, all fields mapped properly

#### 9.3-UNIT-007: Mock orchestrator integration

**Priority**: P0  
**Component**: `app/api/routes/chat.py`  
**Test**: Verify endpoint calls orchestrator methods in correct sequence  
**Mock Requirements**: Mock ChatOrchestrator instance  
**Assertions**: retrieve_candidates, rerank, synthesize_answer called in order

#### 9.3-UNIT-008: Error response formatting

**Priority**: P0  
**Component**: `app/api/routes/chat.py`  
**Test**: Format exception into standardized error response following error model  
**Mock Requirements**: None  
**Assertions**: Error response matches error schema, includes code/message/details/requestId

#### 9.3-UNIT-009: Input sanitization logic

**Priority**: P1  
**Component**: `app/api/routes/chat.py` or schema validators  
**Test**: Sanitize input (strip control characters, handle special cases)  
**Mock Requirements**: None  
**Assertions**: Control characters removed, malicious patterns handled

#### 9.3-UNIT-010: Logging calls verification

**Priority**: P2  
**Component**: `app/api/routes/chat.py`  
**Test**: Verify logging calls are made with correct levels and messages  
**Mock Requirements**: Mock logger  
**Assertions**: Request, response, and error logging occurs

#### 9.3-UNIT-011: Response is not streamed

**Priority**: P2  
**Component**: `app/api/routes/chat.py`  
**Test**: Verify response is complete JSON, not streaming  
**Mock Requirements**: None  
**Assertions**: Response is complete, not chunked or streamed

### Integration Tests (17 scenarios)

#### 9.3-INT-001: Endpoint registration in main app

**Priority**: P0  
**Component**: `app/main.py`, `app/api/routes/chat.py`  
**Test**: Verify chat router is included in main app with correct prefix `/api` and tags  
**Mock Requirements**: None  
**Assertions**: Router included, prefix/tags correct

#### 9.3-INT-002: POST /api/chat endpoint accessible

**Priority**: P1  
**Component**: FastAPI app, chat router  
**Test**: Verify POST /api/chat endpoint is accessible and returns proper response format  
**Mock Requirements**: Mock orchestrator service  
**Assertions**: Endpoint responds to POST requests, returns valid response

#### 9.3-INT-003: Invalid conversation_id returns 400

**Priority**: P0  
**Component**: Endpoint + schema validation  
**Test**: Send request with invalid UUID format, verify 400 with error model  
**Mock Requirements**: None  
**Assertions**: HTTP 400, error follows standardized format

#### 9.3-INT-004: Invalid message length returns 400

**Priority**: P0  
**Component**: Endpoint + schema validation  
**Test**: Send request with message too long/short, verify 400 with error model  
**Mock Requirements**: None  
**Assertions**: HTTP 400, error follows standardized format

#### 9.3-INT-005: Successful response matches schema

**Priority**: P0  
**Component**: Endpoint + orchestrator integration  
**Test**: Send valid request, verify response matches ChatResponse schema  
**Mock Requirements**: Mock orchestrator returning valid response  
**Assertions**: HTTP 200, response matches schema, citations array correct

#### 9.3-INT-006: Citations array structure validation

**Priority**: P1  
**Component**: Endpoint response formatting  
**Test**: Verify citations array has correct structure (doc_id, chunk_id, page_from, page_to, score, text)  
**Mock Requirements**: Mock orchestrator returning chunks  
**Assertions**: Citations array properly formatted, all required fields present

#### 9.3-INT-007: Endpoint calls orchestrator correctly

**Priority**: P0  
**Component**: Endpoint + orchestrator service  
**Test**: Verify endpoint calls orchestrator methods with correct parameters  
**Mock Requirements**: Mock ChatOrchestrator instance  
**Assertions**: Methods called with correct query, top_k values

#### 9.3-INT-008: Orchestrator flow: retrieve → rerank → synthesize

**Priority**: P1  
**Component**: Endpoint + orchestrator service  
**Test**: Verify complete orchestrator flow is executed in correct order  
**Mock Requirements**: Mock ChatOrchestrator with spy on methods  
**Assertions**: retrieve_candidates → rerank → synthesize_answer called in sequence

#### 9.3-INT-009: Orchestrator RuntimeError returns 500

**Priority**: P0  
**Component**: Endpoint + orchestrator error handling  
**Test**: Mock orchestrator to raise RuntimeError, verify 500 with error model  
**Mock Requirements**: Mock orchestrator raising RuntimeError  
**Assertions**: HTTP 500, error follows standardized format

#### 9.3-INT-010: Error response follows standardized format

**Priority**: P1  
**Component**: Endpoint error handling  
**Test**: Verify all error responses follow error model (code, message, details, requestId)  
**Mock Requirements**: Various error scenarios  
**Assertions**: Error responses match error schema

#### 9.3-INT-011: Malicious input sanitization

**Priority**: P1  
**Component**: Endpoint + input validation  
**Test**: Send request with potentially malicious input, verify sanitization  
**Mock Requirements**: Mock orchestrator  
**Assertions**: Input sanitized before processing, no errors from malicious patterns

#### 9.3-INT-012: Prompt injection attempt handling

**Priority**: P2  
**Component**: Endpoint + orchestrator  
**Test**: Send prompt injection attempts, verify system prompt resilience  
**Mock Requirements**: Mock orchestrator, verify prompt construction  
**Assertions**: System prompt remains intact, prompt injection attempts fail

#### 9.3-INT-013: Rate limiting middleware applies to endpoint

**Priority**: P0  
**Component**: Rate limiting middleware + endpoint  
**Test**: Verify rate limiting middleware processes chat endpoint requests  
**Mock Requirements**: Mock rate limiter  
**Assertions**: Rate limiting middleware executes, chat endpoint not excluded

#### 9.3-INT-014: Rate limit exceeded returns 429

**Priority**: P1  
**Component**: Rate limiting middleware + endpoint  
**Test**: Exceed rate limit, verify 429 response with Retry-After header  
**Mock Requirements**: Configure rate limiter to reject requests  
**Assertions**: HTTP 429, Retry-After header present

#### 9.3-INT-015: Request/response logging

**Priority**: P1  
**Component**: Endpoint + logging middleware  
**Test**: Verify request and response are logged with appropriate detail  
**Mock Requirements**: Mock logger or verify log output  
**Assertions**: Request/response logged, user messages truncated if needed

#### 9.3-INT-016: Error logging

**Priority**: P2  
**Component**: Endpoint + error handling  
**Test**: Verify errors are logged with appropriate detail and context  
**Mock Requirements**: Trigger errors, verify logging  
**Assertions**: Errors logged with stack traces, request context

#### 9.3-INT-017: Endpoint accessible without auth

**Priority**: P1  
**Component**: Endpoint + auth middleware  
**Test**: Send request without authentication, verify 200 response  
**Mock Requirements**: None (public endpoint)  
**Assertions**: Endpoint accessible, no auth required

### End-to-End Tests (4 scenarios)

#### 9.3-E2E-001: Error responses visible to client

**Priority**: P1  
**Component**: Full application stack  
**Test**: Trigger orchestrator failure, verify client receives proper error response  
**Mock Requirements**: Mock orchestrator or external services  
**Assertions**: Client receives HTTP 500, error message in standardized format

#### 9.3-E2E-002: Multiple rapid requests trigger rate limit

**Priority**: P2  
**Component**: Full application stack + rate limiting  
**Test**: Send rapid requests exceeding rate limit, verify 429 responses  
**Mock Requirements**: None (real rate limiting)  
**Assertions**: Rate limit enforced, 429 responses after limit exceeded

#### 9.3-E2E-003: Chat works without authentication

**Priority**: P2  
**Component**: Full application stack  
**Test**: Complete chat flow without any authentication, verify success  
**Mock Requirements**: Mock orchestrator  
**Assertions**: Chat request succeeds, response received

#### 9.3-E2E-004: Complete response in single HTTP response

**Priority**: P1  
**Component**: Full application stack  
**Test**: Send chat request, verify complete response (answer + citations) in single response  
**Mock Requirements**: Mock orchestrator  
**Assertions**: Single HTTP response contains all data, no streaming

## Recommended Execution Order

1. **P0 Unit Tests** (fail fast on critical issues)
   - 9.3-UNIT-001, 9.3-UNIT-002, 9.3-UNIT-003, 9.3-UNIT-004, 9.3-UNIT-005, 9.3-UNIT-007, 9.3-UNIT-008
2. **P0 Integration Tests** (critical integration points)
   - 9.3-INT-001, 9.3-INT-003, 9.3-INT-004, 9.3-INT-005, 9.3-INT-007, 9.3-INT-009, 9.3-INT-013
3. **P0 E2E Tests** (critical user paths)
   - None (all E2E are P1 or P2)
4. **P1 Tests** (core functionality)
   - 9.3-UNIT-006, 9.3-UNIT-009
   - 9.3-INT-002, 9.3-INT-006, 9.3-INT-008, 9.3-INT-010, 9.3-INT-011, 9.3-INT-014, 9.3-INT-015, 9.3-INT-017
   - 9.3-E2E-001, 9.3-E2E-004
5. **P2 Tests** (as time permits)
   - 9.3-UNIT-010, 9.3-UNIT-011
   - 9.3-INT-012, 9.3-INT-016
   - 9.3-E2E-002, 9.3-E2E-003

## Test Coverage Summary

### By Acceptance Criteria

- **AC1**: 3 tests (1 unit, 2 integration) ✅
- **AC2**: 5 tests (3 unit, 2 integration) ✅
- **AC3**: 4 tests (2 unit, 2 integration) ✅
- **AC4**: 3 tests (1 unit, 2 integration) ✅
- **AC5**: 4 tests (1 unit, 2 integration, 1 e2e) ✅
- **AC6**: 3 tests (1 unit, 2 integration) ✅
- **AC7**: 3 tests (2 integration, 1 e2e) ✅
- **AC8**: 3 tests (1 unit, 2 integration) ✅
- **AC9**: 2 tests (1 integration, 1 e2e) ✅
- **AC10**: 2 tests (1 unit, 1 e2e) ✅

**Total**: All 10 ACs have comprehensive test coverage ✅

### Coverage Gaps

None identified - all acceptance criteria have test coverage at appropriate levels.

## Test Implementation Notes

### Mock Strategy

- **Chat Orchestrator**: Mock `ChatOrchestrator` class and its methods
- **DeepSeek Client**: Not needed (handled by orchestrator mocking)
- **Database**: Use test database fixture from `conftest.py`
- **Rate Limiter**: Mock `rate_limiter` service for unit tests
- **Logger**: Mock logger for verification of log calls

### Test Data Requirements

- Valid UUID strings for conversation_id testing
- Message samples of various lengths (1, 500, 1000, 1001 characters)
- Mock orchestrator responses with proper chunk structure
- Error scenarios for orchestrator failures

### Test File Structure

```
tests/unit/test_chat_api.py
  - TestChatRequestSchema (AC2)
  - TestChatResponseSchema (AC3)
  - TestChatEndpoint (AC1, AC4, AC5, AC6, AC8, AC10)
  - TestErrorHandling (AC5)
```

## Risk Mitigation Through Testing

### SEC-001 (Public Endpoint Abuse)

- **9.3-INT-013**: Verifies rate limiting applies
- **9.3-INT-014**: Tests rate limit enforcement
- **Additional**: Load testing recommended

### TECH-001 (Service Dependencies)

- **9.3-INT-009**: Tests error handling for orchestrator failures
- **9.3-INT-010**: Validates error response format
- **9.3-INT-008**: Verifies complete orchestrator flow

### PERF-001 (High Latency)

- **9.3-E2E-004**: Validates complete response delivery
- **Additional**: Performance testing recommended

### SEC-002 (Input Sanitization)

- **9.3-UNIT-009**: Tests sanitization logic
- **9.3-INT-011**: Validates sanitization in endpoint
- **9.3-INT-012**: Tests prompt injection resilience

## Quality Checklist

- ✅ Every AC has test coverage
- ✅ Test levels are appropriate (not over-testing)
- ✅ No duplicate coverage across levels
- ✅ Priorities align with business risk
- ✅ Test IDs follow naming convention (9.3-{LEVEL}-{SEQ})
- ✅ Scenarios are atomic and independent
- ✅ Risk mitigations are addressed
- ✅ Critical paths have multiple test levels

## Gate YAML Summary

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 11
    integration: 17
    e2e: 4
  by_priority:
    p0: 14
    p1: 12
    p2: 6
  coverage_gaps: []
```

## Trace References

**For trace-requirements task:**

```
Test design matrix: docs/qa/assessments/9.3-test-design-20250130.md
P0 tests identified: 14
```

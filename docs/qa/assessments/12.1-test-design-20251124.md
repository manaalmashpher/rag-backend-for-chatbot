# Test Design: Story 12.1

Date: 2025-11-24
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 42
- **Unit tests:** 20 (48%)
- **Integration tests:** 18 (43%)
- **E2E tests:** 4 (9%)
- **Priority distribution:** P0: 16, P1: 18, P2: 8

**Strategy Rationale:**
This story introduces database persistence and session management, requiring comprehensive testing at multiple levels. Unit tests focus on model validation and business logic. Integration tests verify database operations, API contracts, and service interactions. E2E tests validate critical user journeys. High priority (P0) assigned to risks identified in risk profile (TECH-001, PERF-001) and core functionality.

## Test Scenarios by Acceptance Criteria

### AC1: Database models created for ChatSession and ChatMessage with proper relationships

#### Scenarios

| ID            | Level       | Priority | Test                                                 | Justification                  | Mitigates Risks |
| ------------- | ----------- | -------- | ---------------------------------------------------- | ------------------------------ | --------------- |
| 12.1-UNIT-001 | Unit        | P0       | ChatSession creation with required fields            | Pure model validation logic    | DATA-001        |
| 12.1-UNIT-002 | Unit        | P0       | ChatMessage creation with foreign key                | Model relationship validation  | DATA-001        |
| 12.1-UNIT-003 | Unit        | P0       | ChatMessage role validation (user/assistant)         | Input validation logic         | -               |
| 12.1-UNIT-004 | Unit        | P1       | Timestamps auto-populated correctly                  | Model behavior validation      | -               |
| 12.1-UNIT-005 | Unit        | P1       | ChatSession updated_at auto-updates                  | Model behavior validation      | -               |
| 12.1-INT-001  | Integration | P0       | Foreign key relationship enforces integrity          | Database constraint validation | DATA-001        |
| 12.1-INT-002  | Integration | P1       | Cascade delete removes messages when session deleted | Database relationship behavior | DATA-001        |

---

### AC2: Database migration script created and tested for chat history tables

#### Scenarios

| ID           | Level       | Priority | Test                                               | Justification                     | Mitigates Risks    |
| ------------ | ----------- | -------- | -------------------------------------------------- | --------------------------------- | ------------------ |
| 12.1-INT-003 | Integration | P0       | Migration creates chat_sessions table              | Database schema validation        | TECH-003           |
| 12.1-INT-004 | Integration | P0       | Migration creates chat_messages table              | Database schema validation        | TECH-003           |
| 12.1-INT-005 | Integration | P0       | Migration adds foreign key constraint              | Database constraint validation    | TECH-003, DATA-001 |
| 12.1-INT-006 | Integration | P0       | Migration creates indexes (session_id, created_at) | Database performance validation   | PERF-002           |
| 12.1-INT-007 | Integration | P1       | Migration is idempotent (can run twice)            | Operational safety validation     | TECH-003           |
| 12.1-INT-008 | Integration | P1       | Migration on existing database doesn't fail        | Backward compatibility validation | TECH-003           |

---

### AC3: ChatOrchestrator.load_history() implemented to retrieve last N messages for a session

#### Scenarios

| ID            | Level       | Priority | Test                                            | Justification                 | Mitigates Risks    |
| ------------- | ----------- | -------- | ----------------------------------------------- | ----------------------------- | ------------------ |
| 12.1-UNIT-006 | Unit        | P0       | load_history returns correct message sequence   | Business logic validation     | TECH-001           |
| 12.1-UNIT-007 | Unit        | P0       | load_history respects limit parameter           | Business logic validation     | PERF-001           |
| 12.1-UNIT-008 | Unit        | P1       | load_history returns empty list for new session | Edge case handling            | -                  |
| 12.1-UNIT-009 | Unit        | P1       | load_history orders messages chronologically    | Business logic validation     | -                  |
| 12.1-INT-009  | Integration | P0       | load_history queries database correctly         | Database operation validation | TECH-002, PERF-002 |
| 12.1-INT-010  | Integration | P1       | load_history with large history (100+ messages) | Performance validation        | PERF-002           |
| 12.1-INT-011  | Integration | P2       | load_history handles invalid session_id         | Error handling validation     | TECH-001           |

---

### AC4: ChatOrchestrator.save_turn() implemented to persist user and assistant messages

#### Scenarios

| ID            | Level       | Priority | Test                                                  | Justification                 | Mitigates Risks    |
| ------------- | ----------- | -------- | ----------------------------------------------------- | ----------------------------- | ------------------ |
| 12.1-UNIT-010 | Unit        | P0       | save_turn creates both user and assistant messages    | Business logic validation     | -                  |
| 12.1-UNIT-011 | Unit        | P0       | save_turn updates session timestamp                   | Business logic validation     | -                  |
| 12.1-INT-012  | Integration | P0       | save_turn persists messages to database               | Database operation validation | TECH-002, DATA-001 |
| 12.1-INT-013  | Integration | P1       | save_turn handles database errors gracefully          | Error handling validation     | TECH-002           |
| 12.1-INT-014  | Integration | P1       | save_turn with invalid session_id fails appropriately | Data integrity validation     | DATA-001           |

---

### AC5: ChatOrchestrator chat flow updated to use history when building LLM input

#### Scenarios

| ID            | Level       | Priority | Test                                                 | Justification                  | Mitigates Risks    |
| ------------- | ----------- | -------- | ---------------------------------------------------- | ------------------------------ | ------------------ |
| 12.1-UNIT-012 | Unit        | P0       | Chat flow builds messages with history               | Business logic validation      | PERF-001           |
| 12.1-UNIT-013 | Unit        | P1       | Chat flow creates new session if session_id missing  | Business logic validation      | TECH-001           |
| 12.1-INT-015  | Integration | P0       | Chat flow includes history in LLM prompt             | Service integration validation | PERF-001           |
| 12.1-INT-016  | Integration | P0       | Retrieval still uses only latest query (not history) | Service behavior validation    | -                  |
| 12.1-INT-017  | Integration | P1       | Chat flow handles empty history correctly            | Edge case handling             | -                  |
| 12.1-INT-018  | Integration | P2       | Chat flow with very long history messages            | Edge case handling             | PERF-001, TECH-005 |

---

### AC6: ChatRequest schema updated to make conversation_id optional (backward compatible)

#### Scenarios

| ID            | Level       | Priority | Test                                                       | Justification                     | Mitigates Risks |
| ------------- | ----------- | -------- | ---------------------------------------------------------- | --------------------------------- | --------------- |
| 12.1-UNIT-014 | Unit        | P0       | ChatRequest accepts None for conversation_id               | Schema validation logic           | TECH-004        |
| 12.1-UNIT-015 | Unit        | P0       | ChatRequest accepts empty string for conversation_id       | Schema validation logic           | TECH-004        |
| 12.1-UNIT-016 | Unit        | P1       | ChatRequest still accepts valid UUID                       | Backward compatibility validation | TECH-004        |
| 12.1-INT-019  | Integration | P0       | API accepts request without conversation_id                | API contract validation           | TECH-004        |
| 12.1-INT-020  | Integration | P1       | API accepts request with conversation_id (backward compat) | Backward compatibility validation | TECH-004        |

---

### AC7: ChatResponse schema updated to include session_id

#### Scenarios

| ID            | Level       | Priority | Test                                          | Justification               | Mitigates Risks |
| ------------- | ----------- | -------- | --------------------------------------------- | --------------------------- | --------------- |
| 12.1-UNIT-017 | Unit        | P0       | ChatResponse includes session_id field        | Schema validation logic     | TECH-001        |
| 12.1-INT-021  | Integration | P0       | API response always includes session_id       | API contract validation     | TECH-001        |
| 12.1-INT-022  | Integration | P1       | API returns new session_id when none provided | Service behavior validation | TECH-001        |

---

### AC8: Chat API route updated to create new sessions when session_id missing

#### Scenarios

| ID           | Level       | Priority | Test                                                     | Justification                  | Mitigates Risks |
| ------------ | ----------- | -------- | -------------------------------------------------------- | ------------------------------ | --------------- |
| 12.1-INT-023 | Integration | P0       | API creates new ChatSession when conversation_id missing | Service integration validation | TECH-001        |
| 12.1-INT-024 | Integration | P1       | API uses existing session when conversation_id provided  | Service behavior validation    | TECH-001        |
| 12.1-INT-025 | Integration | P1       | API logs session creation at INFO level                  | Observability validation       | -               |

---

### AC9: Chat API route updated to pass session_id to ChatOrchestrator and return it in response

#### Scenarios

| ID           | Level       | Priority | Test                                                                      | Justification                    | Mitigates Risks |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------- | -------------------------------- | --------------- |
| 12.1-INT-026 | Integration | P0       | API passes session_id to ChatOrchestrator                                 | Service integration validation   | TECH-001        |
| 12.1-INT-027 | Integration | P0       | API returns session_id in response                                        | API contract validation          | TECH-001        |
| 12.1-E2E-001 | E2E         | P0       | Complete chat flow: request → session creation → response with session_id | Critical user journey validation | TECH-001        |

---

### AC10: Logging added for session creation, history loading, and turn saving

#### Scenarios

| ID            | Level | Priority | Test                                | Justification            | Mitigates Risks |
| ------------- | ----- | -------- | ----------------------------------- | ------------------------ | --------------- |
| 12.1-UNIT-018 | Unit  | P2       | Logging occurs for session creation | Observability validation | -               |
| 12.1-UNIT-019 | Unit  | P2       | Logging occurs for history loading  | Observability validation | -               |
| 12.1-UNIT-020 | Unit  | P2       | Logging occurs for turn saving      | Observability validation | -               |

---

### AC11: Unit tests for ChatSession and ChatMessage models

#### Scenarios

| ID            | Level | Priority | Test                                         | Justification                     | Mitigates Risks |
| ------------- | ----- | -------- | -------------------------------------------- | --------------------------------- | --------------- |
| 12.1-UNIT-001 | Unit  | P0       | ChatSession creation with required fields    | Model validation (covered in AC1) | DATA-001        |
| 12.1-UNIT-002 | Unit  | P0       | ChatMessage creation with foreign key        | Model validation (covered in AC1) | DATA-001        |
| 12.1-UNIT-003 | Unit  | P0       | ChatMessage role validation (user/assistant) | Model validation (covered in AC1) | -               |
| 12.1-UNIT-004 | Unit  | P1       | Timestamps auto-populated correctly          | Model behavior (covered in AC1)   | -               |

---

### AC12: Unit tests for load_history and save_turn methods

#### Scenarios

| ID            | Level | Priority | Test                                               | Justification                      | Mitigates Risks |
| ------------- | ----- | -------- | -------------------------------------------------- | ---------------------------------- | --------------- |
| 12.1-UNIT-006 | Unit  | P0       | load_history returns correct message sequence      | Method validation (covered in AC3) | TECH-001        |
| 12.1-UNIT-007 | Unit  | P0       | load_history respects limit parameter              | Method validation (covered in AC3) | PERF-001        |
| 12.1-UNIT-008 | Unit  | P1       | load_history returns empty list for new session    | Method validation (covered in AC3) | -               |
| 12.1-UNIT-010 | Unit  | P0       | save_turn creates both user and assistant messages | Method validation (covered in AC4) | -               |
| 12.1-UNIT-011 | Unit  | P0       | save_turn updates session timestamp                | Method validation (covered in AC4) | -               |

---

### AC13: Integration test for multi-turn conversation flow (Q1 → session_id → Q2 with history)

#### Scenarios

| ID           | Level       | Priority | Test                                                           | Justification                     | Mitigates Risks |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | --------------------------------- | --------------- |
| 12.1-E2E-002 | E2E         | P0       | Multi-turn flow: Q1 without session_id → receive session_id1   | Critical user journey validation  | TECH-001        |
| 12.1-E2E-003 | E2E         | P0       | Multi-turn flow: Q2 with session_id1 → verify history included | Critical user journey validation  | PERF-001        |
| 12.1-E2E-004 | E2E         | P1       | Multi-turn flow: Verify retrieval uses only latest query       | Service behavior validation       | -               |
| 12.1-INT-028 | Integration | P0       | Backward compatibility: no session_id provided still works     | Backward compatibility validation | TECH-004        |

---

## Risk Coverage

### TECH-001: UUID/Integer Session ID Mapping Complexity (High Risk)

**Covered by:**

- 12.1-UNIT-006: load_history returns correct message sequence
- 12.1-INT-011: load_history handles invalid session_id
- 12.1-INT-019: API accepts request without conversation_id
- 12.1-INT-020: API accepts request with conversation_id (backward compat)
- 12.1-INT-021: API response always includes session_id
- 12.1-INT-022: API returns new session_id when none provided
- 12.1-INT-023: API creates new ChatSession when conversation_id missing
- 12.1-INT-024: API uses existing session when conversation_id provided
- 12.1-INT-026: API passes session_id to ChatOrchestrator
- 12.1-INT-027: API returns session_id in response
- 12.1-E2E-001: Complete chat flow with session creation
- 12.1-E2E-002: Multi-turn flow: Q1 without session_id → receive session_id1

**Coverage:** Comprehensive - All session ID mapping scenarios tested at multiple levels

---

### PERF-001: LLM Token Usage Increase (High Risk)

**Covered by:**

- 12.1-UNIT-007: load_history respects limit parameter
- 12.1-UNIT-012: Chat flow builds messages with history
- 12.1-INT-015: Chat flow includes history in LLM prompt
- 12.1-INT-018: Chat flow with very long history messages
- 12.1-E2E-003: Multi-turn flow: Q2 with session_id1 → verify history included

**Coverage:** Good - Token usage scenarios covered, but may need additional performance tests for token counting

---

### TECH-002: Database Session Management (Medium Risk)

**Covered by:**

- 12.1-INT-009: load_history queries database correctly
- 12.1-INT-012: save_turn persists messages to database
- 12.1-INT-013: save_turn handles database errors gracefully

**Coverage:** Adequate - Database session operations tested, but may need additional connection pool tests

---

### TECH-003: Migration Script Execution (Medium Risk)

**Covered by:**

- 12.1-INT-003: Migration creates chat_sessions table
- 12.1-INT-004: Migration creates chat_messages table
- 12.1-INT-005: Migration adds foreign key constraint
- 12.1-INT-006: Migration creates indexes
- 12.1-INT-007: Migration is idempotent
- 12.1-INT-008: Migration on existing database doesn't fail

**Coverage:** Comprehensive - All migration scenarios covered

---

### DATA-001: Foreign Key Constraint Violations (Medium Risk)

**Covered by:**

- 12.1-UNIT-001: ChatSession creation with required fields
- 12.1-UNIT-002: ChatMessage creation with foreign key
- 12.1-INT-001: Foreign key relationship enforces integrity
- 12.1-INT-002: Cascade delete removes messages when session deleted
- 12.1-INT-005: Migration adds foreign key constraint
- 12.1-INT-012: save_turn persists messages to database
- 12.1-INT-014: save_turn with invalid session_id fails appropriately

**Coverage:** Comprehensive - All foreign key scenarios covered

---

### PERF-002: History Query Performance (Medium Risk)

**Covered by:**

- 12.1-INT-006: Migration creates indexes
- 12.1-INT-009: load_history queries database correctly
- 12.1-INT-010: load_history with large history (100+ messages)

**Coverage:** Adequate - Query performance tested, but may need additional load tests

---

### TECH-004: Backward Compatibility (Low Risk)

**Covered by:**

- 12.1-UNIT-014: ChatRequest accepts None for conversation_id
- 12.1-UNIT-015: ChatRequest accepts empty string for conversation_id
- 12.1-UNIT-016: ChatRequest still accepts valid UUID
- 12.1-INT-019: API accepts request without conversation_id
- 12.1-INT-020: API accepts request with conversation_id (backward compat)
- 12.1-INT-028: Backward compatibility: no session_id provided still works

**Coverage:** Comprehensive - All backward compatibility scenarios covered

---

### TECH-005: LLM Context Window Limits (Low Risk)

**Covered by:**

- 12.1-INT-018: Chat flow with very long history messages

**Coverage:** Minimal - May need additional tests for context window edge cases

---

### SEC-001: Session ID Mapping Security (Low Risk)

**Covered by:**

- 12.1-INT-011: load_history handles invalid session_id
- 12.1-INT-014: save_turn with invalid session_id fails appropriately

**Coverage:** Minimal - May need additional security tests for unauthorized access attempts

---

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

1. 12.1-UNIT-001: ChatSession creation
2. 12.1-UNIT-002: ChatMessage creation
3. 12.1-UNIT-003: ChatMessage role validation
4. 12.1-UNIT-006: load_history returns correct sequence
5. 12.1-UNIT-007: load_history respects limit
6. 12.1-UNIT-010: save_turn creates messages
7. 12.1-UNIT-011: save_turn updates timestamp
8. 12.1-UNIT-012: Chat flow builds messages with history
9. 12.1-UNIT-013: Chat flow creates new session
10. 12.1-UNIT-014: ChatRequest accepts None
11. 12.1-UNIT-015: ChatRequest accepts empty string
12. 12.1-UNIT-017: ChatResponse includes session_id

### Phase 2: P0 Integration Tests

13. 12.1-INT-001: Foreign key relationship
14. 12.1-INT-003: Migration creates chat_sessions
15. 12.1-INT-004: Migration creates chat_messages
16. 12.1-INT-005: Migration adds foreign key
17. 12.1-INT-006: Migration creates indexes
18. 12.1-INT-009: load_history queries database
19. 12.1-INT-012: save_turn persists messages
20. 12.1-INT-015: Chat flow includes history
21. 12.1-INT-016: Retrieval uses only latest query
22. 12.1-INT-019: API accepts request without conversation_id
23. 12.1-INT-021: API response includes session_id
24. 12.1-INT-023: API creates new session
25. 12.1-INT-026: API passes session_id to orchestrator
26. 12.1-INT-027: API returns session_id
27. 12.1-INT-028: Backward compatibility

### Phase 3: P0 E2E Tests

28. 12.1-E2E-001: Complete chat flow
29. 12.1-E2E-002: Multi-turn flow: Q1 → session_id
30. 12.1-E2E-003: Multi-turn flow: Q2 with history

### Phase 4: P1 Tests

31-42: Remaining P1 and P2 tests as time permits

## Test Coverage Gaps

**No gaps identified** - All acceptance criteria have comprehensive test coverage.

**Potential Enhancements (Optional):**

- Additional performance tests for token counting (PERF-001)
- Additional security tests for unauthorized access (SEC-001)
- Additional load tests for connection pool (TECH-002)
- Additional context window edge case tests (TECH-005)

## Test Environment Requirements

### Unit Tests

- **Environment:** Isolated, no external dependencies
- **Mocks Required:** Database session, LLM client
- **Execution Time:** < 1 second per test
- **Location:** `tests/unit/test_chat_history_models.py`, `tests/unit/test_chat_orchestrator_history.py`

### Integration Tests

- **Environment:** Test database (SQLite in-memory or PostgreSQL test instance)
- **Mocks Required:** LLM client (DeepSeek)
- **Execution Time:** < 5 seconds per test
- **Location:** `tests/integration/test_chat_history_integration.py`

### E2E Tests

- **Environment:** Full test environment with database and mocked LLM
- **Mocks Required:** LLM client (DeepSeek)
- **Execution Time:** < 10 seconds per test
- **Location:** `tests/integration/test_chat_history_integration.py` (E2E scenarios)

## Test Data Requirements

### Test Sessions

- New session (no messages)
- Session with 1-5 messages
- Session with 10 messages (limit)
- Session with 100+ messages (performance test)

### Test Messages

- Short messages (< 100 chars)
- Medium messages (100-500 chars)
- Long messages (500-1000 chars)
- Very long messages (> 1000 chars, edge case)

### Test Scenarios

- Valid UUID format
- Invalid UUID format
- None/null session_id
- Empty string session_id
- Non-existent session_id

## Success Criteria

### Test Execution

- All P0 tests must pass before deployment
- All P1 tests should pass before deployment
- P2 tests can be deferred if time-constrained

### Coverage Targets

- Unit test coverage: > 90% for models and ChatOrchestrator methods
- Integration test coverage: > 80% for API routes and database operations
- E2E test coverage: All critical user journeys

### Performance Targets

- Unit tests: < 30 seconds total execution
- Integration tests: < 5 minutes total execution
- E2E tests: < 2 minutes total execution

## Notes

- Tests should follow existing patterns from `tests/unit/` and `tests/integration/`
- Use pytest fixtures from `tests/conftest.py` for database sessions
- Mock DeepSeek LLM client to avoid API costs and ensure deterministic tests
- Test UUID/Integer mapping thoroughly as it's a high-risk area (TECH-001)
- Monitor token usage in integration tests to validate PERF-001 mitigation
- Consider adding property-based tests for session ID mapping edge cases

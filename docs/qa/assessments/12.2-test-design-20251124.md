# Test Design: Story 12.2

Date: 2025-11-24
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 38
- **Unit tests**: 18 (47%)
- **Integration tests**: 16 (42%)
- **E2E tests**: 4 (11%)
- **Priority distribution**: P0: 14, P1: 16, P2: 8

**Strategy Rationale:**
This story introduces frontend session management with localStorage persistence, requiring comprehensive testing at multiple levels. Unit tests focus on localStorage operations, state management, and API service type compatibility. Integration tests verify component interactions, localStorage persistence, and API integration. E2E tests validate critical user journeys. High priority (P0) assigned to risks identified in risk profile (TECH-001, SEC-001) and core functionality.

## Test Scenarios by Acceptance Criteria

### AC1: ChatInterface component updated to use `session_id` from API response instead of generating `conversation_id` locally

#### Scenarios

| ID            | Level       | Priority | Test                                                         | Justification                   | Mitigates Risks |
| ------------- | ----------- | -------- | ------------------------------------------------------------ | ------------------------------- | --------------- |
| 12.2-UNIT-001 | Unit        | P0       | ChatInterface initializes sessionId state as null            | Pure state initialization logic | TECH-004        |
| 12.2-UNIT-002 | Unit        | P0       | ChatInterface updates sessionId from API response            | State update logic              | TECH-004        |
| 12.2-INT-001  | Integration | P0       | ChatInterface receives session_id from API and updates state | Component-API integration       | TECH-004        |
| 12.2-INT-002  | Integration | P1       | ChatInterface does not generate conversation_id locally      | Verify old behavior removed     | -               |

### AC2: `session_id` stored in localStorage for persistence across page reloads

#### Scenarios

| ID            | Level       | Priority | Test                                                  | Justification                      | Mitigates Risks |
| ------------- | ----------- | -------- | ----------------------------------------------------- | ---------------------------------- | --------------- |
| 12.2-UNIT-003 | Unit        | P0       | sessionId saved to localStorage on API response       | localStorage set operation         | TECH-001        |
| 12.2-UNIT-004 | Unit        | P0       | localStorage.setItem wrapped in try-catch             | Error handling logic               | TECH-001        |
| 12.2-UNIT-005 | Unit        | P0       | localStorage.setItem failure handled gracefully       | Error handling fallback            | TECH-001        |
| 12.2-INT-003  | Integration | P0       | sessionId persists in localStorage after API response | Component-localStorage integration | TECH-001        |
| 12.2-INT-004  | Integration | P1       | localStorage key name is consistent                   | Storage key validation             | -               |

### AC3: `session_id` loaded from localStorage on component mount and used for subsequent requests

#### Scenarios

| ID            | Level       | Priority | Test                                                        | Justification                        | Mitigates Risks |
| ------------- | ----------- | -------- | ----------------------------------------------------------- | ------------------------------------ | --------------- |
| 12.2-UNIT-006 | Unit        | P0       | useEffect loads sessionId from localStorage on mount        | Hook dependency and localStorage get | TECH-002        |
| 12.2-UNIT-007 | Unit        | P0       | localStorage.getItem wrapped in try-catch                   | Error handling logic                 | TECH-001        |
| 12.2-UNIT-008 | Unit        | P1       | localStorage.getItem returns null if key doesn't exist      | Edge case handling                   | TECH-001        |
| 12.2-INT-005  | Integration | P0       | ChatInterface uses sessionId from localStorage for API call | Component-localStorage-API flow      | TECH-004        |
| 12.2-INT-006  | Integration | P1       | ChatInterface handles missing localStorage gracefully       | Error scenario                       | TECH-001        |

### AC4: ChatInterface displays full conversation history (all previous messages from session)

#### Scenarios

| ID            | Level       | Priority | Test                                                   | Justification                       | Mitigates Risks |
| ------------- | ----------- | -------- | ------------------------------------------------------ | ----------------------------------- | --------------- |
| 12.2-UNIT-009 | Unit        | P1       | Messages state accumulates user and assistant messages | State management logic              | -               |
| 12.2-INT-007  | Integration | P0       | Multi-turn conversation displays all messages in order | Component state and API integration | TECH-004        |
| 12.2-INT-008  | Integration | P1       | Message history persists during component lifecycle    | State persistence                   | -               |
| 12.2-E2E-001  | E2E         | P1       | User sees conversation history across multiple turns   | Critical user journey               | BUS-001         |

### AC5: "New Conversation" button implemented to clear history and start fresh session

#### Scenarios

| ID            | Level       | Priority | Test                                                          | Justification                 | Mitigates Risks |
| ------------- | ----------- | -------- | ------------------------------------------------------------- | ----------------------------- | --------------- |
| 12.2-UNIT-010 | Unit        | P0       | "New Conversation" button clears sessionId from state         | State management logic        | -               |
| 12.2-UNIT-011 | Unit        | P0       | "New Conversation" button removes sessionId from localStorage | localStorage remove operation | TECH-001        |
| 12.2-UNIT-012 | Unit        | P1       | "New Conversation" button clears messages state               | State management logic        | -               |
| 12.2-UNIT-013 | Unit        | P1       | "New Conversation" button clears citations state              | State management logic        | -               |
| 12.2-UNIT-014 | Unit        | P2       | "New Conversation" button disabled during loading             | UI state management           | -               |
| 12.2-INT-009  | Integration | P0       | "New Conversation" creates new session on next message        | Component-API integration     | TECH-004        |
| 12.2-INT-010  | Integration | P1       | "New Conversation" button visible and clickable               | UI component rendering        | -               |
| 12.2-E2E-002  | E2E         | P1       | User clicks "New Conversation" and starts fresh session       | Critical user journey         | -               |

### AC6: API service updated to send optional `conversation_id` (can be null/undefined for new sessions)

#### Scenarios

| ID            | Level       | Priority | Test                                                         | Justification                   | Mitigates Risks |
| ------------- | ----------- | -------- | ------------------------------------------------------------ | ------------------------------- | --------------- |
| 12.2-UNIT-015 | Unit        | P0       | sendChatMessage accepts null conversationId                  | Type compatibility              | TECH-003        |
| 12.2-UNIT-016 | Unit        | P0       | sendChatMessage accepts undefined conversationId             | Type compatibility              | TECH-003        |
| 12.2-UNIT-017 | Unit        | P0       | sendChatMessage sends null conversation_id when not provided | API request format              | -               |
| 12.2-INT-011  | Integration | P0       | API call with null conversationId creates new session        | API service-backend integration | -               |
| 12.2-INT-012  | Integration | P1       | API call with existing sessionId uses existing session       | API service-backend integration | -               |

### AC7: API service updated to handle `session_id` in response (replaces `conversation_id` field)

#### Scenarios

| ID            | Level       | Priority | Test                                                     | Justification                   | Mitigates Risks |
| ------------- | ----------- | -------- | -------------------------------------------------------- | ------------------------------- | --------------- |
| 12.2-UNIT-018 | Unit        | P0       | ChatResponse type includes session_id field              | TypeScript type compatibility   | TECH-003        |
| 12.2-UNIT-019 | Unit        | P0       | ChatResponse type does not include conversation_id field | TypeScript type compatibility   | TECH-003        |
| 12.2-INT-013  | Integration | P0       | API response session_id extracted and returned           | API service response handling   | -               |
| 12.2-INT-014  | Integration | P1       | API response with session_id handled correctly           | API service-backend integration | -               |

### AC8: ChatPage updated to manage session persistence via localStorage

#### Scenarios

| ID            | Level       | Priority | Test                                                              | Justification                   | Mitigates Risks |
| ------------- | ----------- | -------- | ----------------------------------------------------------------- | ------------------------------- | --------------- |
| 12.2-UNIT-020 | Unit        | P1       | ChatPage does not generate conversationId locally                 | Component behavior verification | -               |
| 12.2-INT-015  | Integration | P1       | ChatPage passes sessionId to ChatInterface (or lets it manage)    | Component integration           | -               |
| 12.2-INT-016  | Integration | P2       | ChatPage does not interfere with ChatInterface session management | Component boundary              | -               |

### AC9: Error handling for localStorage operations (graceful fallback if localStorage unavailable)

#### Scenarios

| ID            | Level       | Priority | Test                                                        | Justification              | Mitigates Risks |
| ------------- | ----------- | -------- | ----------------------------------------------------------- | -------------------------- | --------------- |
| 12.2-UNIT-021 | Unit        | P0       | localStorage.setItem throws exception handled gracefully    | Error handling logic       | TECH-001        |
| 12.2-UNIT-022 | Unit        | P0       | localStorage.getItem throws exception handled gracefully    | Error handling logic       | TECH-001        |
| 12.2-UNIT-023 | Unit        | P0       | localStorage.removeItem throws exception handled gracefully | Error handling logic       | TECH-001        |
| 12.2-UNIT-024 | Unit        | P1       | App continues to function when localStorage unavailable     | Graceful degradation       | TECH-001        |
| 12.2-INT-017  | Integration | P0       | ChatInterface works without localStorage (in-memory only)   | Error scenario integration | TECH-001        |
| 12.2-INT-018  | Integration | P1       | Warning logged when localStorage operations fail            | Error logging              | TECH-001        |
| 12.2-E2E-003  | E2E         | P2       | User experience in private browsing mode                    | Browser compatibility      | TECH-001        |

### AC10: Backward compatibility: existing sessions without localStorage continue to work

#### Scenarios

| ID           | Level       | Priority | Test                                                      | Justification          | Mitigates Risks |
| ------------ | ----------- | -------- | --------------------------------------------------------- | ---------------------- | --------------- |
| 12.2-INT-019 | Integration | P0       | ChatInterface creates new session when localStorage empty | Backward compatibility | DATA-001        |
| 12.2-INT-020 | Integration | P1       | ChatInterface works without localStorage (no persistence) | Backward compatibility | TECH-001        |
| 12.2-E2E-004 | E2E         | P1       | User can chat without localStorage (single session)       | Critical user journey  | TECH-001        |

### AC11: Unit tests for session management and localStorage operations

#### Scenarios

| ID            | Level | Priority | Test                                           | Justification              | Mitigates Risks |
| ------------- | ----- | -------- | ---------------------------------------------- | -------------------------- | --------------- |
| 12.2-UNIT-025 | Unit  | P1       | Unit test coverage for localStorage operations | Test coverage verification | OPS-001         |
| 12.2-UNIT-026 | Unit  | P1       | Unit test coverage for session management      | Test coverage verification | OPS-001         |

### AC12: Integration tests for multi-turn conversation with history persistence

#### Scenarios

| ID           | Level       | Priority | Test                                                      | Justification             | Mitigates Risks |
| ------------ | ----------- | -------- | --------------------------------------------------------- | ------------------------- | --------------- |
| 12.2-INT-021 | Integration | P0       | Multi-turn conversation maintains session across requests | Critical integration flow | TECH-004        |
| 12.2-INT-022 | Integration | P0       | Page reload maintains session via localStorage            | Critical persistence flow | DATA-001        |
| 12.2-INT-023 | Integration | P1       | "New Conversation" clears session and creates new one     | Integration flow          | TECH-004        |

## Risk Coverage

### TECH-001: localStorage API Failures

**Covered by tests:**

- 12.2-UNIT-003, 12.2-UNIT-004, 12.2-UNIT-005 (localStorage set operations)
- 12.2-UNIT-007, 12.2-UNIT-008 (localStorage get operations)
- 12.2-UNIT-011 (localStorage remove operations)
- 12.2-UNIT-021, 12.2-UNIT-022, 12.2-UNIT-023 (error handling)
- 12.2-UNIT-024 (graceful degradation)
- 12.2-INT-003, 12.2-INT-004 (integration with localStorage)
- 12.2-INT-006, 12.2-INT-017, 12.2-INT-018 (error scenarios)
- 12.2-E2E-003 (private browsing mode)

### SEC-001: Session ID Exposure in localStorage

**Covered by tests:**

- 12.2-UNIT-003, 12.2-INT-003 (sessionId storage verification)
- 12.2-INT-004 (localStorage key validation)
- Note: XSS vulnerability testing requires security scanning tools (OWASP ZAP) - not covered in unit/integration tests

### TECH-002: React Hooks Dependency Issues

**Covered by tests:**

- 12.2-UNIT-006 (useEffect hook testing)
- 12.2-INT-005 (component mount and hook execution)

### TECH-003: TypeScript Type Compatibility

**Covered by tests:**

- 12.2-UNIT-015, 12.2-UNIT-016 (optional conversationId)
- 12.2-UNIT-018, 12.2-UNIT-019 (ChatResponse type changes)
- 12.2-INT-011, 12.2-INT-012, 12.2-INT-013, 12.2-INT-014 (type compatibility in integration)

### TECH-004: State Synchronization Issues

**Covered by tests:**

- 12.2-UNIT-001, 12.2-UNIT-002 (state initialization and updates)
- 12.2-INT-001, 12.2-INT-005 (state synchronization with API)
- 12.2-INT-007, 12.2-INT-008 (message history state)
- 12.2-INT-009 (new conversation state clearing)
- 12.2-INT-021, 12.2-INT-022 (multi-turn state persistence)

### DATA-001: localStorage Data Loss

**Covered by tests:**

- 12.2-INT-019, 12.2-INT-020 (empty localStorage handling)
- 12.2-INT-022 (page reload persistence)
- 12.2-E2E-003 (private browsing mode)

### BUS-001: Poor UX if History Lost on Reload

**Covered by tests:**

- 12.2-E2E-001 (conversation history display)
- Note: UX testing requires manual validation - automated tests verify functionality

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

1. **Type Compatibility Tests** (12.2-UNIT-015 through 12.2-UNIT-019)

   - Verify TypeScript types are correct before integration
   - Fast feedback on type errors

2. **localStorage Error Handling** (12.2-UNIT-003 through 12.2-UNIT-005, 12.2-UNIT-007, 12.2-UNIT-008, 12.2-UNIT-011, 12.2-UNIT-021 through 12.2-UNIT-024)

   - Critical error handling logic
   - High risk mitigation (TECH-001)

3. **State Management** (12.2-UNIT-001, 12.2-UNIT-002, 12.2-UNIT-006, 12.2-UNIT-010)
   - Core state management logic
   - Risk mitigation (TECH-004)

### Phase 2: P0 Integration Tests

4. **API Integration** (12.2-INT-001, 12.2-INT-003, 12.2-INT-005, 12.2-INT-011 through 12.2-INT-014, 12.2-INT-017, 12.2-INT-019, 12.2-INT-021, 12.2-INT-022)

   - Verify component-API integration
   - Critical flows

5. **Session Management** (12.2-INT-009)
   - New conversation flow

### Phase 3: P0 E2E Tests

6. **Critical User Journeys** (12.2-E2E-001, 12.2-E2E-002, 12.2-E2E-004)
   - Validate end-to-end functionality
   - User experience verification

### Phase 4: P1 Tests

7. **Additional Coverage** (All remaining P1 tests)
   - Edge cases
   - Secondary flows
   - UI interactions

### Phase 5: P2 Tests (As Time Permits)

8. **Nice-to-Have Coverage** (All P2 tests)
   - UI polish
   - Non-critical edge cases

## Test Environment Requirements

### Unit Tests

- **Framework**: Vitest or Jest
- **Mocking**:
  - localStorage: `Object.defineProperty` or `jest-localstorage-mock`
  - React Query: `@tanstack/react-query` testing utilities
  - API calls: Mock `apiService.sendChatMessage`
- **Setup**: Mock localStorage before each test, clear after each test

### Integration Tests

- **Framework**: React Testing Library + Vitest/Jest
- **Mocking**:
  - API calls: Mock axios or API service
  - localStorage: Use real localStorage with cleanup
- **Setup**:
  - Render ChatInterface component
  - Mock API responses
  - Verify component behavior

### E2E Tests

- **Framework**: Playwright or Cypress (if available)
- **Environment**:
  - Real browser (Chrome, Firefox, Safari)
  - Test localStorage in different modes (normal, private browsing)
- **Setup**:
  - Navigate to chat page
  - Perform user actions
  - Verify results

## Test Data Requirements

### Unit Tests

- **Session IDs**: Valid UUID strings (e.g., "550e8400-e29b-41d4-a716-446655440000")
- **Messages**: Sample user and assistant messages
- **localStorage Keys**: Consistent key name (e.g., "chat_session_id")

### Integration Tests

- **API Responses**: Mock ChatResponse objects with session_id
- **localStorage State**: Pre-populated and empty states
- **Component Props**: ChatInterface props (conversationId removed)

### E2E Tests

- **User Flows**:
  - New session creation
  - Multi-turn conversation
  - "New Conversation" button click
  - Page reload scenarios

## Coverage Gaps

**No coverage gaps identified** - All acceptance criteria have test coverage.

## Test Maintenance Considerations

1. **localStorage Mocking**: Ensure localStorage mocks are consistent across tests
2. **API Mock Updates**: Update API mocks when backend schema changes
3. **Browser Compatibility**: Add browser-specific tests if issues arise
4. **Performance**: Monitor test execution time, optimize slow tests

## Notes

- **Security Testing**: XSS vulnerability testing (SEC-001) requires security scanning tools (OWASP ZAP) and is not covered in automated unit/integration tests
- **UX Testing**: Manual UX validation required for BUS-001 (history display on reload)
- **Browser Testing**: Private browsing mode testing (TECH-001) may require manual testing in addition to automated tests

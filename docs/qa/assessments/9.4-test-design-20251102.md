# Test Design: Story 9.4

Date: 2025-11-02
Designer: Quinn (Test Architect)
Story: 9.4 - DeepSeek API Authentication

## Test Strategy Overview

- **Total test scenarios**: 24
- **Unit tests**: 13 (54%)
- **Integration tests**: 9 (38%)
- **E2E tests**: 2 (8%)
- **Priority distribution**: P0: 9, P1: 10, P2: 5

**Test Strategy Rationale**: This story focuses on authentication and configuration, which requires thorough testing at multiple levels. Security-critical paths (API key handling, error exposure) are prioritized as P0. Configuration and integration points are tested at integration level, while pure logic (error handling, configuration precedence) is tested at unit level. E2E tests validate critical user journeys through the chat API with authentication.

## Test Scenarios by Acceptance Criteria

### AC1: DeepSeek client integrated with Settings configuration system

**Requirement**: Use `Settings.deepseek_api_key` instead of direct `os.getenv`, with backward compatibility

#### Scenarios

| ID           | Level       | Priority | Test                                               | Justification                                        | Mitigates Risks |
| ------------ | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------------- | --------------- |
| 9.4-UNIT-001 | Unit        | P0       | Settings API key takes precedence over env var     | Pure configuration logic - test precedence algorithm | TECH-001        |
| 9.4-UNIT-002 | Unit        | P0       | Env var used as fallback when Settings is None     | Pure configuration logic - test fallback logic       | TECH-001        |
| 9.4-UNIT-003 | Unit        | P1       | Empty string in Settings treated as missing        | Edge case validation logic                           | TECH-001        |
| 9.4-INT-001  | Integration | P1       | DeepSeek client uses Settings when both configured | Component interaction - Settings to client           | TECH-001        |
| 9.4-INT-002  | Integration | P1       | DeepSeek client uses env var when Settings not set | Component interaction - backward compatibility       | TECH-001        |

**Coverage Notes**:

- Unit tests cover the configuration precedence logic in isolation
- Integration tests verify actual Settings integration with DeepSeek client
- No E2E needed - configuration is internal implementation detail

---

### AC2: Bearer token authentication verified and working correctly

**Requirement**: Verify Bearer token format and header transmission to DeepSeek API

#### Scenarios

| ID          | Level       | Priority | Test                                                     | Justification                                        | Mitigates Risks |
| ----------- | ----------- | -------- | -------------------------------------------------------- | ---------------------------------------------------- | --------------- |
| 9.4-INT-003 | Integration | P0       | Valid API key authenticates successfully with DeepSeek   | Component interaction - OpenAI client + DeepSeek API | None            |
| 9.4-INT-004 | Integration | P0       | Authorization header format is "Bearer {key}"            | Component interaction - verify header transmission   | None            |
| 9.4-INT-005 | Integration | P1       | API key is correctly passed to OpenAI client constructor | Component interaction - verify parameter passing     | None            |

**Coverage Notes**:

- Integration level appropriate - testing component interaction (OpenAI client + DeepSeek API)
- Bearer token format handled by OpenAI client, but we verify it's used correctly
- Mock API responses to avoid actual API calls in tests

---

### AC3: Proper error handling for authentication failures

**Requirement**: Handle invalid key, missing key, expired key scenarios with custom exceptions

#### Scenarios

| ID           | Level       | Priority | Test                                                             | Justification                                     | Mitigates Risks   |
| ------------ | ----------- | -------- | ---------------------------------------------------------------- | ------------------------------------------------- | ----------------- |
| 9.4-UNIT-004 | Unit        | P0       | MissingAPIKeyError raised when no key provided                   | Pure error handling logic                         | SEC-003, TECH-002 |
| 9.4-UNIT-005 | Unit        | P0       | InvalidAPIKeyError raised when openai.AuthenticationError caught | Pure error handling logic - exception translation | TECH-002          |
| 9.4-UNIT-006 | Unit        | P0       | API key sanitized in exception messages and logs                 | Security-critical - verify no key exposure        | **SEC-001**       |
| 9.4-UNIT-007 | Unit        | P1       | Other OpenAI exceptions (APIError) not treated as auth errors    | Error categorization logic                        | TECH-002          |
| 9.4-INT-006  | Integration | P0       | Authentication error response doesn't contain API key            | Component interaction - verify error propagation  | **SEC-001**       |
| 9.4-INT-007  | Integration | P1       | Mocked 401 response triggers InvalidAPIKeyError                  | Component interaction - API error handling        | TECH-002          |
| 9.4-INT-008  | Integration | P1       | Mocked network error distinguished from auth error               | Component interaction - error categorization      | TECH-002          |

**Coverage Notes**:

- Unit tests verify exception handling logic and key sanitization
- Integration tests verify error propagation through component boundaries
- SEC-001 (API key exposure) is critical - multiple tests verify sanitization

---

### AC4: Enhanced error messages distinguish authentication from other errors

**Requirement**: Clear error messages that indicate authentication vs. other failures

#### Scenarios

| ID           | Level       | Priority | Test                                                           | Justification                                 | Mitigates Risks  |
| ------------ | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------- | ---------------- |
| 9.4-UNIT-008 | Unit        | P1       | MissingAPIKeyError message clearly indicates missing key       | Error message validation logic                | BUS-001, BUS-002 |
| 9.4-UNIT-009 | Unit        | P1       | InvalidAPIKeyError message clearly indicates invalid key       | Error message validation logic                | BUS-001, BUS-002 |
| 9.4-INT-009  | Integration | P1       | Error response code distinguishes AUTH_ERROR from other errors | Component interaction - error response format | TECH-002         |

**Coverage Notes**:

- Unit tests verify error message content (clarity, helpfulness)
- Integration test verifies error codes follow standardized error model
- Supports user experience and troubleshooting (BUS-001, BUS-002)

---

### AC5: Configuration validation at application startup

**Requirement**: Warn if key missing but allow app to start (non-blocking)

#### Scenarios

| ID           | Level       | Priority | Test                                                         | Justification                                 | Mitigates Risks |
| ------------ | ----------- | -------- | ------------------------------------------------------------ | --------------------------------------------- | --------------- |
| 9.4-INT-010  | Integration | P1       | Startup validation logs warning when key missing             | Component interaction - startup sequence      | OPS-002         |
| 9.4-INT-011  | Integration | P1       | Application starts successfully even with missing key        | Component interaction - non-blocking behavior | OPS-002         |
| 9.4-UNIT-010 | Unit        | P2       | Startup validation function correctly identifies missing key | Pure validation logic                         | OPS-002         |

**Coverage Notes**:

- Integration tests verify startup behavior (non-blocking, logging)
- Unit test verifies validation logic in isolation
- P2 for unit test (validation logic is straightforward)

---

### AC6: Health check integration with DeepSeek configuration check

**Requirement**: `/readyz` includes DeepSeek check (verify key configured, NOT make API calls)

#### Scenarios

| ID           | Level       | Priority | Test                                                                   | Justification                                   | Mitigates Risks |
| ------------ | ----------- | -------- | ---------------------------------------------------------------------- | ----------------------------------------------- | --------------- |
| 9.4-INT-012  | Integration | P0       | Health check verifies API key configuration presence                   | Component interaction - health service          | OPS-002         |
| 9.4-INT-013  | Integration | P0       | Health check makes NO HTTP requests to DeepSeek API                    | **Critical billing risk** - verify no API calls | **OPS-001**     |
| 9.4-INT-014  | Integration | P1       | Health check returns appropriate status (configured/unconfigured)      | Component interaction - health response format  | OPS-002         |
| 9.4-UNIT-011 | Unit        | P0       | Health check function only checks config existence (no API call logic) | Pure logic - verify no API call code paths      | **OPS-001**     |

**Coverage Notes**:

- **OPS-001 (High Risk)**: Multiple tests verify health check doesn't make API calls
- Integration tests verify actual HTTP client isn't invoked
- Unit test verifies code logic doesn't include API call paths
- Critical for cost control

---

### AC7: Comprehensive unit tests for authentication scenarios

**Requirement**: Unit tests cover all authentication scenarios (covered by AC1-AC6 unit tests)

#### Scenarios

| ID           | Level | Priority | Test                                                      | Justification                | Mitigates Risks |
| ------------ | ----- | -------- | --------------------------------------------------------- | ---------------------------- | --------------- |
| 9.4-UNIT-012 | Unit  | P1       | Unit test suite covers all authentication error scenarios | Test completeness validation | Multiple        |

**Coverage Notes**:

- Meta-test to ensure all scenarios are covered
- Covered by previous unit tests (UNIT-001 through UNIT-011)
- May be satisfied by test coverage metrics

---

### AC8: Integration test verifying actual DeepSeek API authentication

**Requirement**: Integration test with mock responses for authentication scenarios

#### Scenarios

| ID          | Level       | Priority | Test                                                         | Justification                                  | Mitigates Risks  |
| ----------- | ----------- | -------- | ------------------------------------------------------------ | ---------------------------------------------- | ---------------- |
| 9.4-INT-015 | Integration | P1       | Integration test suite covers authentication flow end-to-end | Test completeness - integration coverage       | Multiple         |
| 9.4-E2E-001 | E2E         | P0       | Chat endpoint returns proper error when API key invalid      | Critical user journey - authentication failure | BUS-001, BUS-002 |
| 9.4-E2E-002 | E2E         | P1       | Chat endpoint succeeds when API key valid                    | Critical user journey - authentication success | None             |

**Coverage Notes**:

- Integration tests verify component interactions
- E2E tests verify complete user journey through chat API
- E2E-001 is P0 (user-facing critical path with authentication)

---

### AC9: Documentation updated with authentication configuration

**Requirement**: Documentation includes configuration requirements and troubleshooting

#### Scenarios

| ID           | Level  | Priority | Test                                                               | Justification                                    | Mitigates Risks |
| ------------ | ------ | -------- | ------------------------------------------------------------------ | ------------------------------------------------ | --------------- |
| 9.4-UNIT-013 | Manual | P2       | Documentation review: env.example includes DEEPSEEK_API_KEY        | Manual verification - documentation completeness | OPS-002         |
| 9.4-UNIT-014 | Manual | P2       | Documentation review: troubleshooting section includes auth errors | Manual verification - user guidance              | BUS-002         |
| 9.4-UNIT-015 | Manual | P2       | Documentation review: error codes documented                       | Manual verification - API documentation          | TECH-002        |

**Coverage Notes**:

- Manual verification appropriate for documentation
- P2 priority (important but not blocking)
- Can be verified via documentation review checklist

---

## Risk Coverage

### Critical Risks (Score 9)

**SEC-001 (API Key Exposure)**:

- ✅ 9.4-UNIT-006: Unit test verifies key sanitization in messages/logs
- ✅ 9.4-INT-006: Integration test verifies error responses don't contain keys
- **Coverage**: Comprehensive - both unit and integration levels verify sanitization

### High Risks (Score 6)

**OPS-001 (Health Check Billing)**:

- ✅ 9.4-INT-013: Integration test verifies NO HTTP requests made
- ✅ 9.4-UNIT-011: Unit test verifies no API call code paths
- **Coverage**: Comprehensive - explicit tests prevent accidental API calls

**SEC-002 (Plaintext Storage)**:

- ⚠️ Documented in AC9 documentation tests (manual review)
- **Coverage**: Documentation verification (secrets management guidance)

### Medium Risks (Score 4)

**TECH-001 (Backward Compatibility)**:

- ✅ 9.4-UNIT-001, 9.4-UNIT-002: Unit tests for precedence/fallback
- ✅ 9.4-INT-001, 9.4-INT-002: Integration tests for both config methods
- **Coverage**: Comprehensive - tests both configuration paths

**TECH-002 (Error Handling)**:

- ✅ 9.4-UNIT-004, 9.4-UNIT-005: Unit tests for custom exceptions
- ✅ 9.4-INT-007, 9.4-INT-008: Integration tests for error categorization
- ✅ 9.4-INT-009: Integration test for error codes
- **Coverage**: Comprehensive - tests exception handling and categorization

**OPS-002 (Early Detection)**:

- ✅ 9.4-INT-010, 9.4-INT-011: Integration tests for startup validation
- ✅ 9.4-INT-012, 9.4-INT-014: Integration tests for health check
- **Coverage**: Adequate - tests validation and health check

**BUS-001, BUS-002 (Service Degradation)**:

- ✅ 9.4-UNIT-008, 9.4-UNIT-009: Unit tests for clear error messages
- ✅ 9.4-E2E-001: E2E test for user-facing error handling
- **Coverage**: Adequate - tests error clarity and user experience

## Test Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

1. **9.4-UNIT-001**: Settings API key precedence
2. **9.4-UNIT-002**: Env var fallback
3. **9.4-UNIT-004**: MissingAPIKeyError raised
4. **9.4-UNIT-005**: InvalidAPIKeyError raised
5. **9.4-UNIT-006**: API key sanitization (**SEC-001**)
6. **9.4-UNIT-011**: Health check no API calls (**OPS-001**)

**Rationale**: Test core security and configuration logic first. These are fast, isolated tests that catch critical issues early.

### Phase 2: P0 Integration Tests (Critical Interactions)

7. **9.4-INT-003**: Valid authentication flow
8. **9.4-INT-004**: Bearer token header format
9. **9.4-INT-006**: Error response doesn't contain key (**SEC-001**)
10. **9.4-INT-013**: Health check makes NO API calls (**OPS-001**)

**Rationale**: Verify critical component interactions and security concerns before broader integration testing.

### Phase 3: P0 E2E Tests (Critical User Journeys)

11. **9.4-E2E-001**: Chat endpoint error handling

**Rationale**: Validate complete user journey with authentication failure.

### Phase 4: P1 Tests (Core Functionality)

12. **9.4-UNIT-003**: Empty string handling
13. **9.4-UNIT-007**: Other exceptions not treated as auth
14. **9.4-UNIT-008**: MissingAPIKeyError message clarity
15. **9.4-UNIT-009**: InvalidAPIKeyError message clarity
16. **9.4-INT-001**: Settings integration
17. **9.4-INT-002**: Env var backward compatibility
18. **9.4-INT-005**: API key passed to OpenAI client
19. **9.4-INT-007**: Mocked 401 triggers InvalidAPIKeyError
20. **9.4-INT-008**: Network error distinguished
21. **9.4-INT-009**: Error code distinction
22. **9.4-INT-010**: Startup validation warning
23. **9.4-INT-011**: App starts with missing key
24. **9.4-INT-014**: Health check status response
25. **9.4-INT-015**: Integration test completeness
26. **9.4-E2E-002**: Chat endpoint success path

**Rationale**: Complete core functionality coverage after critical paths are validated.

### Phase 5: P2 Tests (Nice to Have)

27. **9.4-UNIT-010**: Startup validation function
28. **9.4-UNIT-012**: Unit test completeness
29. **9.4-UNIT-013**: Documentation review (env.example)
30. **9.4-UNIT-014**: Documentation review (troubleshooting)
31. **9.4-UNIT-015**: Documentation review (error codes)

**Rationale**: Final polish and completeness checks.

## Test Data Requirements

### API Key Test Data

- **Valid API key format**: Test key matching expected format (e.g., "sk-...")
- **Invalid API key format**: Malformed key (wrong prefix, too short, etc.)
- **Missing key**: `None` or empty string
- **Expired/invalid key**: Valid format but rejected by API (mock 401 response)

### Mock Responses

- **Successful authentication**: Mock OpenAI client returning valid ChatCompletion
- **401 Authentication Error**: Mock `openai.AuthenticationError`
- **Other API errors**: Mock `openai.APIError` (non-auth)
- **Network errors**: Mock connection/timeout exceptions

### Configuration Scenarios

- Settings.deepseek_api_key set, env var unset
- Settings.deepseek_api_key unset, env var set
- Both set (Settings takes precedence)
- Both unset (missing key scenario)
- Settings set to empty string vs. None

## Test Environment Requirements

### Unit Tests

- **Dependencies**: pytest, unittest.mock, pytest-mock
- **Isolation**: Full mocking of OpenAI client, Settings, os.getenv
- **Speed**: Fast execution (<1s per test)

### Integration Tests

- **Dependencies**: FastAPI TestClient, pytest, unittest.mock
- **Isolation**: Mock OpenAI client responses, real Settings/health service
- **Speed**: Moderate execution (<5s per test)

### E2E Tests

- **Dependencies**: FastAPI TestClient, pytest, mock responses
- **Isolation**: Mock DeepSeek API responses, real application stack
- **Speed**: Slower execution (<10s per test)

## Test Coverage Goals

### By Priority

- **P0 tests**: 100% pass rate required before deployment
- **P1 tests**: 95% pass rate required before deployment
- **P2 tests**: 80% pass rate (can defer minor failures)

### By Risk

- **Critical risks (SEC-001)**: All related tests must pass
- **High risks (OPS-001, SEC-002)**: All related tests must pass
- **Medium risks**: Related tests should pass, exceptions documented

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, integration for interactions, E2E for journeys)
- [x] No duplicate coverage across levels (each test has unique purpose)
- [x] Priorities align with business risk (security P0, core functionality P1)
- [x] Test IDs follow naming convention (9.4-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Critical risks have comprehensive test coverage
- [x] Health check billing risk (OPS-001) has explicit tests preventing API calls
- [x] API key exposure risk (SEC-001) has tests verifying sanitization

## Recommendations

### Must Implement Before Deployment

1. **API key sanitization tests** (9.4-UNIT-006, 9.4-INT-006):

   - Verify no keys appear in logs or error responses
   - Test with various error scenarios
   - Security-critical (SEC-001)

2. **Health check no-API-call tests** (9.4-INT-013, 9.4-UNIT-011):

   - Explicit verification that no HTTP requests are made
   - Mock HTTP client and verify no calls
   - Billing-critical (OPS-001)

3. **Configuration precedence tests** (9.4-UNIT-001, 9.4-INT-001):
   - Verify Settings takes precedence over env var
   - Verify backward compatibility maintained
   - Technical debt prevention (TECH-001)

### Should Implement Before Production

4. **Error handling comprehensive tests** (9.4-UNIT-004 through 9.4-INT-009):

   - Custom exception types tested
   - Error categorization verified
   - User experience improvement (TECH-002, BUS-001)

5. **E2E authentication flow** (9.4-E2E-001, 9.4-E2E-002):
   - Complete user journey validation
   - Critical path coverage

### Nice to Have

6. **Documentation review tests** (9.4-UNIT-013 through 9.4-UNIT-015):
   - Manual verification checklist
   - Can be part of code review process

## Test Maintenance Notes

- **Mock OpenAI client**: Centralize mocking strategy to avoid duplication
- **Test data**: Create fixtures for API key scenarios to reuse
- **Error message validation**: Update tests if error messages change
- **Health check tests**: Monitor for any changes that might introduce API calls

## Conclusion

The test design provides comprehensive coverage across all acceptance criteria with appropriate test levels. Critical security risks (API key exposure, health check billing) have explicit test coverage. The test suite balances thoroughness with efficiency, favoring unit tests for logic and integration tests for component interactions. E2E tests focus on critical user journeys only.

**Total Scenarios**: 24 automated + 3 manual documentation reviews  
**Execution Time Estimate**: ~2-3 minutes for full suite  
**Coverage**: All ACs covered, all critical/high risks mitigated with tests

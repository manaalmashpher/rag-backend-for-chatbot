# Test Design: Story 9.1

Date: 2025-10-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 8 (53%)
- Integration tests: 5 (33%)
- E2E tests: 2 (13%)
- Priority distribution: P0: 6, P1: 6, P2: 3

## Test Scenarios by Acceptance Criteria

### AC1: DeepSeek client (`app/deps/deepseek_client.py`) with OpenAI-compatible interface

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                |
| ------------ | ----------- | -------- | --------------------------------------- | ---------------------------- |
| 9.1-UNIT-001 | Unit        | P0       | Client initialization with valid config | Pure configuration logic     |
| 9.1-UNIT-002 | Unit        | P0       | OpenAI-compatible interface compliance  | API contract validation      |
| 9.1-INT-001  | Integration | P1       | Client connects to DeepSeek API         | External service integration |

### AC2: Function `deepseek_chat(messages, temperature=0.1, max_tokens=700)` returns content string

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                   |
| ------------ | ----------- | -------- | ----------------------------------- | ------------------------------- |
| 9.1-UNIT-003 | Unit        | P0       | Function signature validation       | Pure function interface testing |
| 9.1-UNIT-004 | Unit        | P0       | Default parameter handling          | Business logic validation       |
| 9.1-INT-002  | Integration | P1       | Successful API call returns content | Service interaction validation  |
| 9.1-INT-003  | Integration | P1       | Error handling for API failures     | Error boundary testing          |

### AC3: Environment variable `DEEPSEEK_API_KEY` configuration

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                   |
| ------------ | ----------- | -------- | ------------------------------ | ------------------------------- |
| 9.1-UNIT-005 | Unit        | P1       | Environment variable loading   | Configuration logic             |
| 9.1-UNIT-006 | Unit        | P1       | Missing API key validation     | Error handling logic            |
| 9.1-INT-004  | Integration | P2       | Configuration integration test | System configuration validation |

### AC4: OpenAI-compatible client with base_url: `https://api.deepseek.com/v1`

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                    |
| ------------ | ----------- | -------- | --------------------------------- | -------------------------------- |
| 9.1-UNIT-007 | Unit        | P0       | Base URL configuration validation | Configuration logic              |
| 9.1-INT-005  | Integration | P1       | Correct endpoint resolution       | Network configuration validation |

### AC5: Model: `deepseek-chat`

#### Scenarios

| ID           | Level | Priority | Test                       | Justification       |
| ------------ | ----- | -------- | -------------------------- | ------------------- |
| 9.1-UNIT-008 | Unit  | P1       | Model parameter validation | Configuration logic |

### AC6: No streaming, no tools, no extra features (MVP scope)

#### Scenarios

| ID          | Level | Priority | Test                              | Justification                   |
| ----------- | ----- | -------- | --------------------------------- | ------------------------------- |
| 9.1-E2E-001 | E2E   | P2       | End-to-end chat flow validation   | Complete user journey           |
| 9.1-E2E-002 | E2E   | P2       | MVP scope compliance verification | Business requirement validation |

## Risk Coverage

### SEC-001: API Key Exposure Risk

- **9.1-UNIT-006**: Tests missing API key validation (prevents empty key exposure)
- **9.1-INT-004**: Tests configuration integration (validates secure config handling)

### PERF-001: DeepSeek API Rate Limiting

- **9.1-INT-003**: Tests error handling for API failures (includes rate limit scenarios)
- **9.1-E2E-001**: Tests complete flow under normal conditions (baseline performance)

### TECH-001: OpenAI Client Library Compatibility

- **9.1-UNIT-002**: Tests OpenAI-compatible interface compliance
- **9.1-INT-001**: Tests actual client connection (validates library compatibility)

### PERF-002: Network Timeout Handling

- **9.1-INT-003**: Tests error handling for API failures (includes timeout scenarios)

### OPS-001: Missing Environment Variable Validation

- **9.1-UNIT-005**: Tests environment variable loading
- **9.1-UNIT-006**: Tests missing API key validation

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on critical issues)

   - 9.1-UNIT-001: Client initialization validation
   - 9.1-UNIT-002: OpenAI-compatible interface compliance
   - 9.1-UNIT-003: Function signature validation
   - 9.1-UNIT-004: Default parameter handling
   - 9.1-UNIT-007: Base URL configuration validation

2. **P0 Integration tests**

   - 9.1-INT-002: Successful API call validation
   - 9.1-INT-003: Error handling for API failures

3. **P1 Unit tests**

   - 9.1-UNIT-005: Environment variable loading
   - 9.1-UNIT-006: Missing API key validation
   - 9.1-UNIT-008: Model parameter validation

4. **P1 Integration tests**

   - 9.1-INT-001: Client connects to DeepSeek API
   - 9.1-INT-004: Configuration integration test
   - 9.1-INT-005: Correct endpoint resolution

5. **P2 E2E tests** (as time permits)
   - 9.1-E2E-001: End-to-end chat flow validation
   - 9.1-E2E-002: MVP scope compliance verification

## Test Implementation Guidelines

### Unit Test Requirements

- **Mock Strategy**: Mock OpenAI client library calls
- **Test Data**: Use predefined message arrays and response objects
- **Assertions**: Validate function signatures, return types, and error conditions
- **Coverage**: >90% for P0 tests, >80% for P1 tests

### Integration Test Requirements

- **Test Environment**: Use test API keys and sandbox endpoints
- **Network Simulation**: Test timeout and connection failure scenarios
- **Error Scenarios**: Test rate limiting, authentication failures, and malformed responses
- **Coverage**: >80% for P0 tests, >60% for P1 tests

### E2E Test Requirements

- **Environment**: Full application stack with test configuration
- **User Journey**: Complete chat interaction from request to response
- **Validation**: End-to-end functionality and MVP scope compliance
- **Coverage**: Critical paths only

## Test Data Requirements

### Mock Data

```python
# Valid message format
valid_messages = [
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "What is the weather today?"}
]

# Mock API response
mock_response = {
    "choices": [{"message": {"content": "I cannot provide weather information."}}]
}
```

### Test Configuration

```python
# Test environment variables
test_config = {
    "DEEPSEEK_API_KEY": "test_key_12345",
    "DEEPSEEK_BASE_URL": "https://api.deepseek.com/v1",
    "DEEPSEEK_MODEL": "deepseek-chat"
}
```

## Quality Assurance Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk mitigations are addressed
- [x] Test execution order is optimized for fast feedback

## Coverage Gaps

None identified - all acceptance criteria have appropriate test coverage.

## Test Maintenance Considerations

- **Mock Updates**: Update mocks when OpenAI client library changes
- **Configuration Changes**: Update test configs when DeepSeek API changes
- **Error Scenarios**: Add new error scenarios as they're discovered in production
- **Performance Baselines**: Update performance expectations as system scales

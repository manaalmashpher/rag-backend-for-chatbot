# Test Design: Story 9.5

Date: 2025-11-04
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 32
- **Unit tests**: 14 (44%)
- **Integration tests**: 12 (38%)
- **E2E tests**: 6 (19%)
- **Priority distribution**: P0: 8, P1: 14, P2: 8, P3: 2

## Test Scenarios by Acceptance Criteria

### AC1: Create new chat page (`src/pages/ChatPage.tsx`) with chat interface

#### Scenarios

| ID           | Level       | Priority | Test                                   | Justification                                |
| ------------ | ----------- | -------- | -------------------------------------- | -------------------------------------------- |
| 9.5-UNIT-001 | Unit        | P1       | ChatPage component renders correctly   | Component rendering is pure React logic      |
| 9.5-UNIT-002 | Unit        | P1       | ChatPage wraps ChatInterface component | Component composition validation             |
| 9.5-INT-001  | Integration | P0       | ChatPage route accessible at /chat     | Routing integration critical for user access |
| 9.5-INT-002  | Integration | P0       | ChatPage protected by ProtectedRoute   | Authentication integration required          |
| 9.5-INT-003  | Integration | P1       | ChatPage uses Layout wrapper           | UI consistency integration                   |
| 9.5-E2E-001  | E2E         | P1       | User navigates to /chat and sees chat  | Critical user journey validation             |

### AC2: Chat interface displays conversation history with user messages and assistant responses

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                            |
| ------------ | ----------- | -------- | --------------------------------------- | ---------------------------------------- |
| 9.5-UNIT-003 | Unit        | P0       | Message array renders correctly         | Pure rendering logic, core functionality |
| 9.5-UNIT-004 | Unit        | P1       | User messages display right-aligned     | UI state logic validation                |
| 9.5-UNIT-005 | Unit        | P1       | Assistant messages display left-aligned | UI state logic validation                |
| 9.5-INT-004  | Integration | P0       | Messages persist in component state     | State management integration             |
| 9.5-INT-005  | Integration | P1       | New messages append to conversation     | State update integration                 |
| 9.5-E2E-002  | E2E         | P1       | User sees conversation history in UI    | User experience validation               |

### AC3: Input box and send functionality for submitting chat messages

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                 |
| ------------ | ----------- | -------- | --------------------------------------- | ----------------------------- |
| 9.5-UNIT-006 | Unit        | P0       | Input accepts text input                | Pure component behavior       |
| 9.5-UNIT-007 | Unit        | P0       | Send button submits message             | Core interaction logic        |
| 9.5-UNIT-008 | Unit        | P1       | Enter key submits message               | Keyboard shortcut logic       |
| 9.5-UNIT-009 | Unit        | P2       | Shift+Enter creates new line (textarea) | Secondary input behavior      |
| 9.5-UNIT-010 | Unit        | P0       | Send button disabled when input empty   | Input validation logic        |
| 9.5-INT-006  | Integration | P0       | Submit triggers API call                | API integration critical path |
| 9.5-E2E-003  | E2E         | P0       | User types and submits message          | Critical user journey         |

### AC4: Citations side panel displaying source information

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                  |
| ------------ | ----------- | -------- | ----------------------------------- | ------------------------------ |
| 9.5-UNIT-011 | Unit        | P1       | Citations sorted by score (desc)    | Pure sorting algorithm         |
| 9.5-UNIT-012 | Unit        | P1       | Score formatted as percentage       | Formatting logic               |
| 9.5-UNIT-013 | Unit        | P2       | Text truncated at 200 chars         | UI formatting logic            |
| 9.5-INT-007  | Integration | P1       | Citations display from API response | API data integration           |
| 9.5-INT-008  | Integration | P1       | Empty citations array shows message | Edge case handling integration |
| 9.5-INT-009  | Integration | P2       | Citations panel responsive (mobile) | Responsive layout integration  |
| 9.5-E2E-004  | E2E         | P1       | User sees citations after response  | User experience validation     |

### AC5: Stable conversation_id (UUID generated on component mount, persists for session)

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                |
| ------------ | ----------- | -------- | --------------------------------------- | ---------------------------- |
| 9.5-UNIT-014 | Unit        | P1       | UUID generated on mount                 | Pure function logic          |
| 9.5-UNIT-015 | Unit        | P1       | Conversation ID persists across renders | State persistence logic      |
| 9.5-INT-010  | Integration | P0       | Conversation ID sent in API requests    | API integration critical     |
| 9.5-INT-011  | Integration | P1       | Conversation ID lost on page refresh    | Session boundary integration |

### AC6: Integration with POST /api/chat endpoint using existing API service pattern

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                    |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 9.5-UNIT-016 | Unit        | P0       | sendChatMessage function exists         | API service function validation  |
| 9.5-UNIT-017 | Unit        | P1       | TypeScript interfaces defined correctly | Type safety validation           |
| 9.5-INT-012  | Integration | P0       | useMutation hook calls API correctly    | React Query integration critical |
| 9.5-INT-013  | Integration | P0       | API request includes conversation_id    | API contract validation          |
| 9.5-INT-014  | Integration | P0       | API request includes message            | API contract validation          |
| 9.5-E2E-005  | E2E         | P0       | User message triggers API call          | Critical end-to-end flow         |

### AC7: Error handling for API failures with user-friendly error messages

#### Scenarios

| ID           | Level       | Priority | Test                                   | Justification                       |
| ------------ | ----------- | -------- | -------------------------------------- | ----------------------------------- |
| 9.5-UNIT-018 | Unit        | P0       | Error message extracted from response  | Error parsing logic                 |
| 9.5-INT-015  | Integration | P0       | Network error displays user message    | Error handling integration critical |
| 9.5-INT-016  | Integration | P0       | API 400 error displays user message    | API error integration               |
| 9.5-INT-017  | Integration | P0       | API 500 error displays user message    | API error integration               |
| 9.5-INT-018  | Integration | P1       | Timeout error displays user message    | Error scenario integration          |
| 9.5-E2E-006  | E2E         | P1       | User sees error message on API failure | User experience validation          |

### AC8: Loading states during API requests

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                |
| ------------ | ----------- | -------- | ----------------------------------- | ---------------------------- |
| 9.5-UNIT-019 | Unit        | P1       | Loading state shows during request  | State management logic       |
| 9.5-UNIT-020 | Unit        | P1       | Input disabled during loading       | UI state logic               |
| 9.5-UNIT-021 | Unit        | P1       | Send button disabled during loading | UI state logic               |
| 9.5-INT-019  | Integration | P1       | Loading state clears on success     | State transition integration |
| 9.5-INT-020  | Integration | P1       | Loading state clears on error       | State transition integration |

### AC9: Responsive design matching existing UI patterns (Tailwind CSS)

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification                 |
| ------------ | ----------- | -------- | ------------------------------------- | ----------------------------- |
| 9.5-UNIT-022 | Unit        | P2       | Tailwind classes applied correctly    | Styling validation            |
| 9.5-INT-021  | Integration | P2       | Mobile layout (<768px) displays below | Responsive layout integration |
| 9.5-INT-022  | Integration | P2       | Desktop layout displays side-by-side  | Responsive layout integration |
| 9.5-E2E-007  | E2E         | P2       | UI responsive on mobile device        | User experience validation    |

### AC10: Existing search page remains unchanged and fully functional

#### Scenarios

| ID          | Level       | Priority | Test                                  | Justification                  |
| ----------- | ----------- | -------- | ------------------------------------- | ------------------------------ |
| 9.5-INT-023 | Integration | P0       | SearchPage route still accessible     | Regression prevention critical |
| 9.5-INT-024 | Integration | P0       | SearchPage functionality unchanged    | Regression prevention critical |
| 9.5-E2E-008 | E2E         | P0       | User can navigate between search/chat | User journey validation        |

## Risk Coverage

### High Priority Risks (PERF-001)

**Risk**: Long conversation history causing rendering performance degradation

**Test Coverage**:

- **9.5-INT-025** (P1): Test performance with 50+ messages
- **9.5-INT-026** (P2): Test memory usage with long conversations

### Medium Priority Risks

**TECH-002: React Query useMutation integration complexity**

- **Coverage**: 9.5-INT-012, 9.5-INT-013, 9.5-INT-014 (all P0)

**SEC-002: Insufficient frontend input validation**

- **Coverage**: 9.5-UNIT-010 (P0), 9.5-UNIT-006 (P0)

**SEC-003: Public chat endpoint without user authentication**

- **Coverage**: 9.5-INT-002 (P0) - ProtectedRoute verification

**PERF-002: API latency from DeepSeek calls**

- **Coverage**: 9.5-UNIT-019, 9.5-UNIT-020, 9.5-UNIT-021 (all P1) - Loading states

**OPS-001: Incomplete error handling coverage**

- **Coverage**: 9.5-INT-015, 9.5-INT-016, 9.5-INT-017, 9.5-INT-018 (all P0-P1)

### Low Priority Risks

**TECH-001: Routing and navigation integration**

- **Coverage**: 9.5-INT-001, 9.5-INT-002, 9.5-E2E-008 (all P0-P1)

**BUS-001: User confusion from new chat interface**

- **Coverage**: 9.5-E2E-008 (P0) - Navigation between search/chat

## Test Scenarios Summary Table

| ID           | Level       | Priority | AC  | Description                             | Mitigates Risk    |
| ------------ | ----------- | -------- | --- | --------------------------------------- | ----------------- |
| 9.5-UNIT-001 | Unit        | P1       | 1   | ChatPage component renders correctly    |                   |
| 9.5-UNIT-002 | Unit        | P1       | 1   | ChatPage wraps ChatInterface component  |                   |
| 9.5-UNIT-003 | Unit        | P0       | 2   | Message array renders correctly         |                   |
| 9.5-UNIT-004 | Unit        | P1       | 2   | User messages display right-aligned     |                   |
| 9.5-UNIT-005 | Unit        | P1       | 2   | Assistant messages display left-aligned |                   |
| 9.5-UNIT-006 | Unit        | P0       | 3   | Input accepts text input                | SEC-002           |
| 9.5-UNIT-007 | Unit        | P0       | 3   | Send button submits message             |                   |
| 9.5-UNIT-008 | Unit        | P1       | 3   | Enter key submits message               |                   |
| 9.5-UNIT-009 | Unit        | P2       | 3   | Shift+Enter creates new line (textarea) |                   |
| 9.5-UNIT-010 | Unit        | P0       | 3   | Send button disabled when input empty   | SEC-002           |
| 9.5-UNIT-011 | Unit        | P1       | 4   | Citations sorted by score (desc)        |                   |
| 9.5-UNIT-012 | Unit        | P1       | 4   | Score formatted as percentage           |                   |
| 9.5-UNIT-013 | Unit        | P2       | 4   | Text truncated at 200 chars             |                   |
| 9.5-UNIT-014 | Unit        | P1       | 5   | UUID generated on mount                 |                   |
| 9.5-UNIT-015 | Unit        | P1       | 5   | Conversation ID persists across renders |                   |
| 9.5-UNIT-016 | Unit        | P0       | 6   | sendChatMessage function exists         |                   |
| 9.5-UNIT-017 | Unit        | P1       | 6   | TypeScript interfaces defined correctly |                   |
| 9.5-UNIT-018 | Unit        | P0       | 7   | Error message extracted from response   | OPS-001           |
| 9.5-UNIT-019 | Unit        | P1       | 8   | Loading state shows during request      | PERF-002          |
| 9.5-UNIT-020 | Unit        | P1       | 8   | Input disabled during loading           | PERF-002          |
| 9.5-UNIT-021 | Unit        | P1       | 8   | Send button disabled during loading     | PERF-002          |
| 9.5-UNIT-022 | Unit        | P2       | 9   | Tailwind classes applied correctly      |                   |
| 9.5-INT-001  | Integration | P0       | 1   | ChatPage route accessible at /chat      | TECH-001          |
| 9.5-INT-002  | Integration | P0       | 1   | ChatPage protected by ProtectedRoute    | SEC-003           |
| 9.5-INT-003  | Integration | P1       | 1   | ChatPage uses Layout wrapper            |                   |
| 9.5-INT-004  | Integration | P0       | 2   | Messages persist in component state     |                   |
| 9.5-INT-005  | Integration | P1       | 2   | New messages append to conversation     |                   |
| 9.5-INT-006  | Integration | P0       | 3   | Submit triggers API call                |                   |
| 9.5-INT-007  | Integration | P1       | 4   | Citations display from API response     |                   |
| 9.5-INT-008  | Integration | P1       | 4   | Empty citations array shows message     |                   |
| 9.5-INT-009  | Integration | P2       | 4   | Citations panel responsive (mobile)     |                   |
| 9.5-INT-010  | Integration | P0       | 5   | Conversation ID sent in API requests    |                   |
| 9.5-INT-011  | Integration | P1       | 5   | Conversation ID lost on page refresh    |                   |
| 9.5-INT-012  | Integration | P0       | 6   | useMutation hook calls API correctly    | TECH-002          |
| 9.5-INT-013  | Integration | P0       | 6   | API request includes conversation_id    | TECH-002          |
| 9.5-INT-014  | Integration | P0       | 6   | API request includes message            | TECH-002          |
| 9.5-INT-015  | Integration | P0       | 7   | Network error displays user message     | OPS-001           |
| 9.5-INT-016  | Integration | P0       | 7   | API 400 error displays user message     | OPS-001           |
| 9.5-INT-017  | Integration | P0       | 7   | API 500 error displays user message     | OPS-001           |
| 9.5-INT-018  | Integration | P1       | 7   | Timeout error displays user message     | OPS-001           |
| 9.5-INT-019  | Integration | P1       | 8   | Loading state clears on success         |                   |
| 9.5-INT-020  | Integration | P1       | 8   | Loading state clears on error           |                   |
| 9.5-INT-021  | Integration | P2       | 9   | Mobile layout (<768px) displays below   |                   |
| 9.5-INT-022  | Integration | P2       | 9   | Desktop layout displays side-by-side    |                   |
| 9.5-INT-023  | Integration | P0       | 10  | SearchPage route still accessible       |                   |
| 9.5-INT-024  | Integration | P0       | 10  | SearchPage functionality unchanged      |                   |
| 9.5-INT-025  | Integration | P1       | -   | Performance with 50+ messages           | PERF-001          |
| 9.5-INT-026  | Integration | P2       | -   | Memory usage with long conversations    | PERF-001          |
| 9.5-E2E-001  | E2E         | P1       | 1   | User navigates to /chat and sees chat   |                   |
| 9.5-E2E-002  | E2E         | P1       | 2   | User sees conversation history in UI    |                   |
| 9.5-E2E-003  | E2E         | P0       | 3   | User types and submits message          |                   |
| 9.5-E2E-004  | E2E         | P1       | 4   | User sees citations after response      |                   |
| 9.5-E2E-005  | E2E         | P0       | 6   | User message triggers API call          |                   |
| 9.5-E2E-006  | E2E         | P1       | 7   | User sees error message on API failure  | OPS-001           |
| 9.5-E2E-007  | E2E         | P2       | 9   | UI responsive on mobile device          |                   |
| 9.5-E2E-008  | E2E         | P0       | 10  | User can navigate between search/chat   | TECH-001, BUS-001 |

## Recommended Execution Order

### Phase 1: Critical Path (P0 Tests)

1. **9.5-INT-001**: ChatPage route accessible (fail fast on routing)
2. **9.5-INT-002**: ProtectedRoute verification (security)
3. **9.5-UNIT-003**: Message rendering (core functionality)
4. **9.5-UNIT-006**: Input validation (security)
5. **9.5-UNIT-007**: Send button functionality (core)
6. **9.5-UNIT-010**: Input validation (security)
7. **9.5-UNIT-016**: API service function (core)
8. **9.5-INT-012**: React Query integration (critical)
9. **9.5-INT-013**: API request format (critical)
10. **9.5-INT-014**: API request format (critical)
11. **9.5-INT-010**: Conversation ID in requests (critical)
12. **9.5-INT-015**: Network error handling (critical)
13. **9.5-INT-016**: API 400 error handling (critical)
14. **9.5-INT-017**: API 500 error handling (critical)
15. **9.5-INT-023**: SearchPage regression (critical)
16. **9.5-INT-024**: SearchPage regression (critical)
17. **9.5-E2E-003**: User submit message (critical journey)
18. **9.5-E2E-005**: API call triggered (critical journey)
19. **9.5-E2E-008**: Navigation between pages (regression)

### Phase 2: High Priority (P1 Tests)

20. All remaining P1 unit tests (14-021)
21. All remaining P1 integration tests (004-011, 018-020, 025)
22. All remaining P1 E2E tests (001, 002, 004, 006)

### Phase 3: Medium/Low Priority (P2-P3 Tests)

23. P2 unit tests (009, 013, 022)
24. P2 integration tests (009, 021-022, 026)
25. P2 E2E tests (007)
26. P3 tests (if time permits)

## Test Environment Requirements

### Unit Tests

- **Framework**: Vitest + React Testing Library
- **Mocking**: Mock React Query hooks, mock API service
- **Isolation**: No external dependencies
- **Execution Time**: <3 minutes total

### Integration Tests

- **Framework**: Vitest + React Testing Library + MSW (Mock Service Worker)
- **Mocking**: Mock API endpoints with MSW
- **Environment**: Test React Router setup
- **Execution Time**: <10 minutes total

### E2E Tests

- **Framework**: Playwright or Cypress (if available)
- **Environment**: Full application stack
- **Browser Coverage**: Chrome (minimum)
- **Device Coverage**: Desktop (minimum)
- **Execution Time**: <20 minutes total

## Test Data Requirements

### Chat Messages

- Valid messages: 1-1000 characters, normal text
- Invalid messages: Empty, >1000 characters
- Edge cases: Special characters, Unicode, very long messages

### API Responses

- Success responses: Valid ChatResponse with answer and citations
- Error responses: 400, 500, network errors, timeout
- Edge cases: Empty citations, malformed JSON, missing fields

### Citations

- Valid citations: Full data with all fields
- Edge cases: Empty array, missing optional fields (page_from/page_to), very high/low scores

### Conversation IDs

- Valid UUIDs: Standard UUID v4 format
- Edge cases: Invalid UUID format (if possible)

## Coverage Targets

### By Priority Level

- **P0 Tests**: 100% coverage required (18 tests)
- **P1 Tests**: 90% coverage required (14 tests)
- **P2 Tests**: 70% coverage required (8 tests)
- **P3 Tests**: 50% coverage acceptable (2 tests)

### By Test Level

- **Unit Tests**: >80% code coverage
- **Integration Tests**: >70% integration point coverage
- **E2E Tests**: 100% critical user journey coverage

### By Acceptance Criteria

- **AC1**: 6 tests (1 unit, 4 integration, 1 E2E)
- **AC2**: 6 tests (3 unit, 2 integration, 1 E2E)
- **AC3**: 7 tests (5 unit, 1 integration, 1 E2E)
- **AC4**: 7 tests (3 unit, 3 integration, 1 E2E)
- **AC5**: 4 tests (2 unit, 2 integration)
- **AC6**: 5 tests (2 unit, 3 integration, 1 E2E)
- **AC7**: 6 tests (1 unit, 4 integration, 1 E2E)
- **AC8**: 5 tests (3 unit, 2 integration)
- **AC9**: 4 tests (1 unit, 2 integration, 1 E2E)
- **AC10**: 3 tests (3 integration, 1 E2E)

## Quality Gates

### Test Execution Gates

- All P0 tests must pass before deployment
- All P1 tests must pass before production release
- P2 tests should pass but can be deferred if blocking
- P3 tests are nice-to-have

### Coverage Gates

- Unit test coverage: >80%
- Integration test coverage: >70%
- E2E test coverage: 100% of critical paths
- Overall test coverage: >75%

## Test Implementation Notes

### Mocking Strategy

1. **API Service Mocking**: Mock `apiService.sendChatMessage` for unit tests
2. **React Query Mocking**: Use `@tanstack/react-query` testing utilities
3. **MSW for Integration**: Mock `/api/chat` endpoint with MSW
4. **Router Mocking**: Use `MemoryRouter` for unit/integration tests

### Test Utilities Needed

1. **Mock API Response Factory**: Create mock ChatResponse objects
2. **Mock Error Factory**: Create mock ChatError objects
3. **Test Render Helper**: Wrapper for React Testing Library with providers
4. **Conversation ID Generator**: Consistent UUID generation for tests

### Known Testing Challenges

1. **React Query useMutation**: Requires proper provider setup in tests
2. **Auto-scroll Behavior**: May require mocking scrollIntoView
3. **Responsive Design**: Requires viewport manipulation in tests
4. **Performance Testing**: May need separate performance test suite

## Test Maintenance Considerations

1. **Component Changes**: Update tests when ChatInterface API changes
2. **API Schema Changes**: Update mocks when ChatResponse schema changes
3. **Routing Changes**: Update tests when route paths change
4. **Error Handling**: Update tests when error message format changes

## Trace References

Test design matrix: `docs/qa/assessments/9.5-test-design-20251104.md`
P0 tests identified: 18
Total scenarios: 32
